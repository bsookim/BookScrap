package com.shop.service;

import java.net.MalformedURLException;
import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.ThreadLocalRandom;

import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.StaleElementReferenceException;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.edge.EdgeDriver;
import org.openqa.selenium.edge.EdgeOptions;
import org.openqa.selenium.support.events.EventFiringDecorator;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.Select;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.shop.dto.CoupangAttributesDto;
import com.shop.dto.CoupangContentsDto;
import com.shop.dto.CoupangDetailsDto;
import com.shop.dto.CoupangDto;
import com.shop.dto.CoupangImagesDto;
import com.shop.dto.CoupangItemsDto;
import com.shop.entity.CoupangItemsRepository;
import com.shop.entity.CoupangRepository;
import com.shop.jdbc.CoupangJdbcRepository;
import com.shop.listener.CustomWebDriverListener;
import com.shop.selenium.cafe.dto.SCoupangCafeDto;
import com.shop.selenium.cafe.dto.SCoupangCafeLoginDto;
import com.shop.selenium.cafe.dto.SCoupangCafePageDto;
import com.shop.selenium.util.ProductUtils;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class CoupangCafe24Service {
	
	private final CoupangJdbcRepository coupangJdbcRepository;
	private final CoupangRepository coupangRepository;
	
	@Value("${file.detail-dir}")
	private String detailDir;
	
	@Value("${file.thmb-dir}")
	private String thmbDir;

	public void loginUrl(String username, String password, String url, int startPage, int endPage) throws InterruptedException, MalformedURLException {

	    EdgeOptions options = new EdgeOptions();
	    options.addArguments("--start-maximized"); // 브라우저 창 최대화

	    WebDriver baseDriver = new EdgeDriver(options);

	    CustomWebDriverListener eventListener = new CustomWebDriverListener(baseDriver);
	    EventFiringDecorator<WebDriver> decorator = new EventFiringDecorator<>(eventListener);
	    WebDriver driver = decorator.decorate(baseDriver);

	    // 로그인 실행
	    SCoupangCafeLoginDto login = new SCoupangCafeLoginDto(driver);

	    login.click(username, password, url);

	    Thread.sleep(3000);

		productPage(driver, username, password, url, startPage, endPage, eventListener);

	    // 브라우저 종료
	    driver.quit();
	}
	
	private void productPage(WebDriver driver,String username,String password ,String companyUrl, int startPage
			, int endPage,CustomWebDriverListener eventListener)
			throws InterruptedException, MalformedURLException {
	
		SCoupangCafePageDto page = new SCoupangCafePageDto(driver);
		List<String> urls = page.productNextPage(startPage, endPage);
		
		for(String url : urls) {
			driver.navigate().to(url);
			SCoupangCafeDto dto = new SCoupangCafeDto(driver);
			WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(5));

			String title = dto.getTitle().getText().trim();
			
			List<WebElement> rows = dto.getInfoArea();
			String price = "";
			String productCode="";
			String makeCompany="";

			for (WebElement row : rows) {
			    WebElement th = row.findElement(By.tagName("th"));
			    if(th.getText().contains("판매가")) {
			    	WebElement td = row.findElement(By.tagName("td"));
			        price = td.getText().trim();
		        }else if (th.getText().contains("상품코드")) {
			        WebElement td = row.findElement(By.tagName("td"));
			        productCode = td.getText().trim();
			    }else if (th.getText().equals("제조사")) {
			    	WebElement td = row.findElement(By.tagName("td"));
			        makeCompany = td.getText().trim();
			    	
			    }
			}
			
			int priceElement = ProductUtils.productPriceConverter(price);
			
			Integer existCode = coupangRepository.existsByProductCode(productCode, title);
			if (existCode == null || existCode == 0) {
				StringBuilder sbDetailFileName = new StringBuilder();
				
				ThreadLocalRandom.current().nextInt(3000, 10000 + 1);

				//썸네일
				String thmbUrl = dto.getThmbImageUrls(new StringBuilder(),thmbDir);
				System.out.println(thmbUrl);
				JavascriptExecutor js = (JavascriptExecutor) driver;
				js.executeScript("window.scrollBy(0, 500);");	
				
				String detailUrl = dto.getDetailImageUrls(new StringBuilder(),detailDir);
				System.out.println(detailUrl);
				//정렬
				sbDetailFileName.append("<p align='center'>");
				
				sbDetailFileName.append(detailUrl);
				
				sbDetailFileName.append("</p>");
				
				// 셀렉트박스 개수
				StringBuilder selectBoxEnabled = new StringBuilder();
				int size = dto.getSelectBox().size();
				String repeatedString = "F|".repeat(size);
				selectBoxEnabled.append(repeatedString);

				if (selectBoxEnabled.toString().equals("F|") || selectBoxEnabled.toString().equals("F|F|")|| selectBoxEnabled.toString().equals("F|F|F|")) {

					CoupangDto coupangDto = new CoupangDto();
					coupangDto.setSellerProductName(title);
					coupangDto.setVendorId("A00962060");
					coupangDto.setDisplayProductName(title);
					coupangDto.setSaleStartedAt("2024-01-19T00:00:00");
					coupangDto.setSaleEndedAt("2099-01-19T00:00:00");
					coupangDto.setDeliveryMethod("SEQUENCIAL");
					coupangDto.setDeliveryCompanyCode("EPOST");
					coupangDto.setDeliveryChargeType("NOT_FREE");
					coupangDto.setDeliveryCharge(3000);
					coupangDto.setFreeShipOverAmount(30000);
					coupangDto.setDeliveryChargeOnReturn(3000);
					coupangDto.setRemoteAreaDeliverable("N");
					coupangDto.setUnionDeliveryType("NOT_UNION_DELIVERY");
					coupangDto.setReturnCenterCode("1001694769");
					coupangDto.setReturnChargeName("경기도 안산시 상록구 충장로 565 111동1203호");
					coupangDto.setCompanyContactNumber("010-8900-6085");
					coupangDto.setReturnZipCode("15287");
					coupangDto.setReturnAddress("경기도 안산시 상록구 충장로 565");
					coupangDto.setReturnAddressDetail("111동1203호");
					coupangDto.setReturnCharge(3000);
					coupangDto.setOutboundShippingPlaceCode(19389011);
					coupangDto.setVendorUserId("qudtn0295");
					coupangDto.setRequested(true);
					coupangDto.setProductCode(productCode);
					coupangDto.setManufacture(makeCompany);
					coupangDto.setCurrentUrl(driver.getCurrentUrl());

					long coupangId = CoupangProductOneSave(coupangDto);
					System.out.println(selectBoxEnabled.toString());
					processOptions(dto.getSelectBox(), 0, driver, "", coupangId, priceElement, thmbUrl.toString(),
							sbDetailFileName.toString(), selectBoxEnabled.toString(), "", "", "",wait);

				} else if (selectBoxEnabled.toString().isEmpty()) {

					// 단일 상품
					List<CoupangAttributesDto> attributes = new ArrayList<>();
					List<CoupangItemsDto> items = new ArrayList<>();
					List<CoupangImagesDto> images = new ArrayList<>();
					List<CoupangContentsDto> contents = new ArrayList<>();
					List<CoupangDetailsDto> details = new ArrayList<>();

					CoupangDto coupang = new CoupangDto();
					coupang.setSellerProductName(title);
					coupang.setVendorId("A00962060");
					coupang.setDisplayProductName(title);
					coupang.setSaleStartedAt("2024-01-19T00:00:00");
					coupang.setSaleEndedAt("2099-01-19T00:00:00");
					coupang.setDeliveryMethod("SEQUENCIAL");
					coupang.setDeliveryCompanyCode("EPOST");
					coupang.setDeliveryChargeType("NOT_FREE");
					coupang.setDeliveryCharge(3000);
					coupang.setFreeShipOverAmount(30000);
					coupang.setDeliveryChargeOnReturn(3000);
					coupang.setRemoteAreaDeliverable("N");
					coupang.setUnionDeliveryType("NOT_UNION_DELIVERY");
					coupang.setReturnCenterCode("1001694769");
					coupang.setReturnChargeName("경기도 안산시 상록구 충장로 565 111동1203호");
					coupang.setCompanyContactNumber("010-8900-6085");
					coupang.setReturnZipCode("15287");
					coupang.setReturnAddress("경기도 안산시 상록구 충장로 565");
					coupang.setReturnAddressDetail("111동1203호");
					coupang.setReturnCharge(3000);
					coupang.setOutboundShippingPlaceCode(19389011);
					coupang.setVendorUserId("qudtn0295");
					coupang.setRequested(true);
					coupang.setProductCode(productCode);
					coupang.setManufacture(makeCompany);
					coupang.setCurrentUrl(driver.getCurrentUrl());

					String optionName = title;
					int productPrice = priceElement;
					
					String thmbnail = thmbUrl.toString();
					
					String detailImage = sbDetailFileName.toString();
					
					coupangSingleProudctSave(coupang, items, attributes, images, contents, details, optionName,
							productPrice, thmbnail, detailImage);
				}
		}
		}
	}
	
	private void processOptions(List<WebElement> allSelects, int index, WebDriver driver, String combinedOption,
			Long coupangId, int price, String thmb, String detailImages, String selectBox, String firstOption,
			String secondOption, String thirdOption,WebDriverWait wait) throws InterruptedException {
			List<CoupangAttributesDto> attributes = new ArrayList<>();
			List<CoupangItemsDto> items = new ArrayList<>();
			List<CoupangImagesDto> images = new ArrayList<>();
			List<CoupangContentsDto> contents = new ArrayList<>();
			List<CoupangDetailsDto> details = new ArrayList<>();
			
			// 모든 옵션을 처리했을 때 종료
			if (index >= allSelects.size()) {
				if (selectBox.equals("F|") || selectBox.equals("F|F|") || selectBox.equals("F|F|F|")) {
					CoupangItemsDto coupangItems = new CoupangItemsDto();
					coupangItems.setCoupangId(coupangId);
					coupangItems.setItemName(combinedOption.trim());
					coupangItems.setMaximumBuyCount(10);
					coupangItems.setMaximumBuyForPerson(0);
					coupangItems.setMaximumBuyForPersonPeriod(1);
					coupangItems.setOutboundShippingTimeDay(3);
					coupangItems.setUnitCount(0);
					coupangItems.setAdultOnly("EVERYONE");
					coupangItems.setTaxType("TAX");
					coupangItems.setParallelImported("NOT_PARALLEL_IMPORTED");
					coupangItems.setOverseasPurchased("NOT_OVERSEAS_PURCHASED");
					coupangItems.setPccNeeded(false);
					coupangItems.setOriginalPrice(price);
					coupangItems.setSalePrice(price);
					items.add(coupangItems);
					Long coupangItemsId = coupangJdbcRepository.recursiveItemsSave(coupangId, coupangItems);

					CoupangImagesDto coupangImages = new CoupangImagesDto();
					coupangImages.setCoupangId(coupangId);
					coupangImages.setImageOrder(0);
					coupangImages.setImageType("REPRESENTATION");
					coupangImages.setVendorPath("https://qudtn0295.cafe24.com/web/product/big/thmb100/" + thmb);
					coupangImages.setCoupangItemsId(coupangItemsId);
					images.add(coupangImages);

					CoupangContentsDto coupangContents = new CoupangContentsDto();
					coupangContents.setCoupangId(coupangId);
					coupangContents.setContentsType("TEXT");
					coupangContents.setCoupangItemsId(coupangItemsId);
					contents.add(coupangContents);

					Long coupangItemsContentsId = coupangJdbcRepository.recursiveItemsAndContentsSave(coupangContents);
					CoupangDetailsDto coupangDetails = new CoupangDetailsDto();
					coupangDetails.setCoupangId(coupangId);
					coupangDetails.setContent(detailImages);
					coupangDetails.setDetailType("TEXT");
					coupangDetails.setCoupangContentsId(coupangItemsContentsId);
					details.add(coupangDetails);

					// 속성 추가
					if (selectBox.equals("F|")) {
						CoupangAttributesDto coupangAttributes = new CoupangAttributesDto();
						coupangAttributes.setCoupangId(coupangId);
						coupangAttributes.setAttributeTypeName("옵션");
						coupangAttributes.setAttributeValueName(firstOption);
						coupangAttributes.setCoupangItem(coupangItemsId);

						attributes.add(coupangAttributes);
					} else if (selectBox.equals("F|F|") && !combinedOption.isEmpty()) {
						CoupangAttributesDto coupangAttributes = new CoupangAttributesDto();
						coupangAttributes.setCoupangId(coupangId);
						coupangAttributes.setAttributeTypeName("옵션");
						coupangAttributes.setAttributeValueName(secondOption);
						coupangAttributes.setCoupangItem(coupangItemsId);

						CoupangAttributesDto coupangAttributes2 = new CoupangAttributesDto();
						coupangAttributes2.setCoupangId(coupangId);
						coupangAttributes2.setAttributeTypeName("옵션2");
						coupangAttributes2.setAttributeValueName(firstOption);
						coupangAttributes2.setCoupangItem(coupangItemsId);

						attributes.add(coupangAttributes);
						attributes.add(coupangAttributes2);
					} else if (selectBox.equals("F|F|F|") && !combinedOption.isEmpty()) {
						CoupangAttributesDto coupangAttributes = new CoupangAttributesDto();
						coupangAttributes.setAttributeTypeName("옵션");
						coupangAttributes.setAttributeValueName(secondOption);
						coupangAttributes.setCoupangId(coupangId);
						coupangAttributes.setCoupangItem(coupangItemsId);

						CoupangAttributesDto coupangAttributes2 = new CoupangAttributesDto();
						coupangAttributes2.setAttributeTypeName("옵션2");
						coupangAttributes2.setAttributeValueName(firstOption);
						coupangAttributes2.setCoupangId(coupangId);
						coupangAttributes.setCoupangItem(coupangItemsId);

						CoupangAttributesDto coupangAttributes3 = new CoupangAttributesDto();
						coupangAttributes3.setAttributeTypeName("옵션3");
						coupangAttributes3.setAttributeValueName(thirdOption);
						coupangAttributes3.setCoupangId(coupangId);
						coupangAttributes.setCoupangItem(coupangItemsId);

						attributes.add(coupangAttributes);
						attributes.add(coupangAttributes2);
						attributes.add(coupangAttributes3);
					}
				}
				CoupangProductSave(coupangId,items,images,attributes,details,contents);
	
				return;
			}
	
	
			WebElement currentSelectElement = allSelects.get(index);
		    Select select;
		    
		    try {
		    	select = new Select(currentSelectElement);
		    	select.selectByIndex(2);
		    }catch (NoSuchElementException e) {
		    	select = new Select(currentSelectElement);
		    	select.selectByIndex(2);
		    	select.getOptions().remove(0);
		    }
		    
		    try {
		    	allSelects = wait.until(ExpectedConditions.visibilityOfAllElements(driver.findElements(By.cssSelector("#contents > div.xans-element-.xans-product.xans-product-detail.section > div.detailArea > div.infoArea.ez-discount-tag-on > table.xans-element-.xans-product.xans-product-option.xans-record- > tbody.xans-element-.xans-product.xans-product-option.xans-record- > tr > td >select"))));
		        List<WebElement> options = wait.until(ExpectedConditions.visibilityOfAllElements(select.getOptions()));
		        options.remove(0);

		        for (WebElement option : options) {
		            String optionValue = option.getText().trim();
		            if (!optionValue.isEmpty() && !optionValue.equals("-------------------") && !optionValue.contains("품절")) {
		                try {
		                    String newCombinedOption = combinedOption.isEmpty() ? optionValue : combinedOption + " " + optionValue;
		                    if (index == 0) {
		                        processOptions(allSelects, index + 1, driver, newCombinedOption, coupangId, price, thmb,
		                                       detailImages, selectBox, optionValue, secondOption, thirdOption,wait);
		                    } else if (index == 1) {
		                        processOptions(allSelects, index + 1, driver, newCombinedOption, coupangId, price, thmb,
		                                       detailImages, selectBox, firstOption, optionValue, thirdOption,wait);
		                    } else if (index == 2) {
		                        processOptions(allSelects, index + 1, driver, newCombinedOption, coupangId, price, thmb,
		                                       detailImages, selectBox, firstOption, secondOption, optionValue,wait);
		                    }
		                } catch (StaleElementReferenceException e) {
		                	System.out.println("Element became stale: " + e.getMessage());
		                }
		            }
		        }
		    } catch (NoSuchElementException | StaleElementReferenceException e) {
		        System.out.println("Error processing options: " + e.getMessage());
		    }
	}
	
	@Transactional
	private void coupangSingleProudctSave(CoupangDto coupang, List<CoupangItemsDto> items,
			List<CoupangAttributesDto> attributes, List<CoupangImagesDto> images, List<CoupangContentsDto> contents,
			List<CoupangDetailsDto> details, String optionName, int productPrice, String thmbnail, String detailImage) {

		long coupangId = coupangJdbcRepository.save(coupang);
	
		CoupangItemsDto coupangItems = new CoupangItemsDto();
		coupangItems.setItemName(optionName);
		coupangItems.setMaximumBuyCount(10);
		coupangItems.setMaximumBuyForPerson(0);
		coupangItems.setMaximumBuyForPersonPeriod(1);
		coupangItems.setOutboundShippingTimeDay(3);
		coupangItems.setUnitCount(0);
		coupangItems.setAdultOnly("EVERYONE");
		coupangItems.setTaxType("TAX");
		coupangItems.setParallelImported("NOT_PARALLEL_IMPORTED");
		coupangItems.setOverseasPurchased("NOT_OVERSEAS_PURCHASED");
		coupangItems.setPccNeeded(false);
		coupangItems.setOriginalPrice(productPrice);
		coupangItems.setSalePrice(productPrice);
		coupangItems.setCoupangId(coupangId);
		items.add(coupangItems);
		List<Long> coupangItemsId = coupangJdbcRepository.itemsSave(coupangId, items);
	
		for (Long itemId : coupangItemsId) {
			CoupangImagesDto coupangImages = new CoupangImagesDto();
			coupangImages.setImageOrder(0);
			coupangImages.setImageType("REPRESENTATION");
			coupangImages.setVendorPath("https://qudtn0295.cafe24.com/web/product/big/thmb100/" + thmbnail);
			coupangImages.setCoupangItemsId(itemId);
			coupangImages.setCoupangId(coupangId);
			images.add(coupangImages);
	
			CoupangContentsDto coupangContents = new CoupangContentsDto();
			coupangContents.setContentsType("TEXT");
			coupangContents.setCoupangId(coupangId);
			coupangContents.setCoupangItemsId(itemId);
			contents.add(coupangContents);
	
		}
	
		List<Long> coupangContensId = coupangJdbcRepository.itemsImagesAndContentsSave(images, contents, coupangId);
		for (Long contentsId : coupangContensId) {
			CoupangDetailsDto coupangDetails = new CoupangDetailsDto();
			coupangDetails.setContent(detailImage);
			coupangDetails.setDetailType("TEXT");
			coupangDetails.setCoupangContentsId(contentsId);
			coupangDetails.setCoupangId(coupangId);
			details.add(coupangDetails);
		}
		coupangJdbcRepository.itemsDetailsSave(details);

	}
	@Transactional
	private Long CoupangProductOneSave(CoupangDto coupangDto) {
		long coupangId = coupangJdbcRepository.save(coupangDto);
		return coupangId;
	}

	@Transactional
	private void CoupangProductSave(Long coupangId, List<CoupangItemsDto> items, List<CoupangImagesDto> images,
			List<CoupangAttributesDto> attributes, List<CoupangDetailsDto> details, List<CoupangContentsDto> contents) {

		coupangJdbcRepository.itemsImagesSave(images);
		coupangJdbcRepository.itemsAttriutesSave(attributes);
		coupangJdbcRepository.itemsDetailsSave(details);
	}
}
		
		
