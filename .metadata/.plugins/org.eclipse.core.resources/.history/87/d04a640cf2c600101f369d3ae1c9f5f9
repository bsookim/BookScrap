package com.scrap.pom;

import java.util.ArrayList;
import java.util.List;

import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.FindBy;
import org.openqa.selenium.support.PageFactory;

import com.scrap.data.BooksData;
import com.scrap.entity.BookCategory;
import com.scrap.entity.Books;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;

@NoArgsConstructor
@AllArgsConstructor
@Getter
public class SeleniumBooks {
	
	//초기화를 반드시 해줘야 함 
	public void init(WebDriver driver) {
        PageFactory.initElements(driver, this);
    }
	
	@FindBy(css="#content_inner > article > div.row > div.col-sm-6.product_main > h1")
	private WebElement title;
	
	@FindBy(css="#content_inner > article > div.row > div.col-sm-6.product_main > p.price_color")
	private WebElement price;
	
	@FindBy(css="#content_inner > article > div.row > div.col-sm-6.product_main > p.instock.availability")
	private WebElement stock;
	
	@FindBy(css="#content_inner > article > p")
	private WebElement descpription;
	
	@FindBy(xpath = "//table[@class='table table-striped']//th[text()='UPC']/following-sibling::td")
	private WebElement upc;

	@FindBy(xpath = "//table[@class='table table-striped']//th[text()='Product Type']/following-sibling::td")
	private WebElement productType;
	
	@FindBy(css="#product_gallery > div > div > div > img")
	private WebElement thumbNail;
	
	@FindBy(css="#default > div > div > ul li a")
	private List<WebElement> categoryList;
	
	public BooksData booksHref(WebDriver driver, SeleniumBookCategory sbc) {
	    BooksData bookData = new BooksData();

	    List<String> categoryUrls = new ArrayList<>();
	    for (WebElement category : sbc.getCategoryUrls()) {
	        String href = category.getDomProperty("href");
	        categoryUrls.add(href);
	        BookCategory bookCategory = BookCategory.builder()
	            .categoryUrl(href)
	            .categoryText(category.getText())
	            .build();

	        bookData.getBookCategoryList().add(bookCategory);
	    }
 
	    List<String> hrefs =  new ArrayList<>();
	    List<WebElement> hrefsOnPage  = new ArrayList<>();
	    for (String categoryUrl : categoryUrls) {
	        driver.get(categoryUrl);

	        Integer end = null;
	        try {
		        WebElement endPageElement = driver.findElement(
		        	    By.cssSelector("#default > div > div > div > div > section > div:nth-child(2) > div > ul > li.current")
		        	);
	        	end = Integer.parseInt(endPageElement.getText().replaceAll("Page 1 of ", ""));
	        }catch(NoSuchElementException e) {
	        	
	        }
	        
	        if(end==null) {
		        //페이지가 1페이지밖에없음
	        	hrefsOnPage = driver.findElements(
	        	        By.cssSelector("div.image_container a")
	        	    );
	        	hrefs.addAll(detailUrls(hrefsOnPage));

	        }else {
	        	//여러페이지
	        	//페이지 이동 시 list를 계속 재조회 해야함 button도 마찬가지
	        	for (Integer i = 1; i < end; i++) {
	        	    hrefsOnPage = driver.findElements(
	        	        By.cssSelector("div.image_container a")
	        	    );
	        	    hrefs.addAll(detailUrls(hrefsOnPage));
	        	    List<WebElement> nextButtons = driver.findElements(
	        	        By.cssSelector("li.next > a")
	        	    );
	        	    if (!nextButtons.isEmpty()) {
	        	        clickNoSuchException(nextButtons.get(0));
	        	    } 
	        	}
        	
	        }
	    }
	    bookData.getUrls().addAll(hrefs);
	    
	    return bookData;
	}

	public List<Books> booksDetailPage(WebDriver driver, List<String> urls) {
	    List<Books> books = new ArrayList<>();

	    for (String url : urls) {
	        driver.get(url);
	        SeleniumBooks sb = new SeleniumBooks();
	        PageFactory.initElements(driver, sb);
	        //일부 사이트들 보면 옵션 클릭 시 썸네일이나 가격정보가 변경되는 경우가 있음.
	        //하지만 해당 사이트에 상세정보는 옵션이 없고 동적 움직임이 없는 사이트이다 보니 jsoup가 훨씬 더 적합해보임
	        //결론 : 추후에 jsoup로 변경
	        Books book = Books.builder()
	            .title(textNoSuchException(sb.getTitle()))
	            .price(textNoSuchException(sb.getPrice()))
	            .stock(textNoSuchException(sb.getStock()))//숫자만 나오게하는 정규표현식 숫자가 아닌 문자는 모두 ""으로 대체
	            .upc(textNoSuchException(sb.getUpc()))
	            .productType(textNoSuchException(sb.getProductType()))
	            .descpription(textNoSuchException(sb.getDescpription()))
	            .currnetUrl(driver.getCurrentUrl())
	            .thumbNail(sb.getThumbNail().getDomProperty("src"))
	            .category(getCategoryTexts())
	            .build();
	        books.add(book);
	    }

	    return books;
	}
	
	public List<String> getCategoryTexts() {
	    List<String> categories = new ArrayList<>();
	    if(categoryList != null) {
	        for (WebElement li : categoryList) {
	            try {
	                WebElement aTag = li.findElement(By.tagName("a"));
	                categories.add(aTag.getText().trim());
	            } catch (NoSuchElementException e) {
	                categories.add(li.getText().trim());
	            }
	        }
	    }
	    System.out.println(categories);
	    return categories;
	}
	
	public List<String> detailUrls(List<WebElement> list){
		List<String> urls = new ArrayList<>();
		for(WebElement a : list) {
			String url = a.getDomProperty("href");
			System.out.println(url);
			urls.add(url);
		}
		return urls;
	}
	
	public String textNoSuchException(WebElement element) {
		String text ="";
		try {
			text = element.getText();
		}catch(NoSuchElementException e){
			System.out.println(e);
		}
		return text;
	}
	
	public void clickNoSuchException(WebElement element) {
		try {
			element.click();
		}catch(NoSuchElementException e){
			System.out.println(e);
		}
	}
}
