package com.coupang.service;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.function.Function;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;
import java.net.URL;
import java.time.Duration;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.openqa.selenium.Alert;
import org.openqa.selenium.By;
import org.openqa.selenium.ElementNotInteractableException;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.Keys;
import org.openqa.selenium.NoAlertPresentException;
import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.NoSuchSessionException;
import org.openqa.selenium.StaleElementReferenceException;
import org.openqa.selenium.TimeoutException;
import org.openqa.selenium.UnhandledAlertException;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.edge.EdgeDriver;
import org.openqa.selenium.edge.EdgeOptions;
import org.openqa.selenium.interactions.Actions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.FluentWait;
import org.openqa.selenium.support.ui.Select;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.springframework.beans.factory.annotation.Value;import org.springframework.boot.autoconfigure.service.connection.ConnectionDetailsFactoryNotFoundException;
import org.springframework.data.domain.PageRequest;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.coupang.api.key.CoupangApiKey;
import com.coupang.dto.created.CoupangAttributesCreateDto;
import com.coupang.dto.created.CoupangContentsCreateDto;
import com.coupang.dto.created.CoupangCreateDto;
import com.coupang.dto.created.CoupangDetailsCreateDto;
import com.coupang.dto.created.CoupangImagesCreateDto;
import com.coupang.dto.created.CoupangItemsCreateDto;
import com.coupang.dto.created.CoupangStocksCreateDto;
import com.coupang.dto.response.CoupangApiDetailResponse;
import com.coupang.dto.response.CoupangDeleteProductResponse;
import com.coupang.dto.response.CoupangDetailItemResponse;
import com.coupang.dto.response.CoupangItemStatusDTO;
import com.coupang.entity.Coupang;
import com.coupang.entity.CoupangAttributes;
import com.coupang.entity.CoupangContents;
import com.coupang.entity.CoupangDetails;
import com.coupang.entity.CoupangImages;
import com.coupang.entity.CoupangItems;
import com.coupang.entity.CoupangUserItemsStatus;
import com.coupang.hamc.product.client.CoupangProductClient;
import com.coupang.repository.CoupangApiKeyRepository;
import com.coupang.repository.CoupangAttributesRepository;
import com.coupang.repository.CoupangContentsRepository;
import com.coupang.repository.CoupangDetailsRepository;
import com.coupang.repository.CoupangImagesRepository;
import com.coupang.repository.CoupangItemsRepository;
import com.coupang.repository.CoupangRepository;
import com.coupang.repository.CoupangUserItemsStatusRepository;
import com.coupang.selenium.dto.CoupangJsoupInfoDto;
import com.coupang.selenium.dto.CoupangStocksDto;
import com.coupang.selenium.dto.SCoupangCafeDto;
import com.coupang.selenium.dto.SeleniumSessionManager;
import com.coupang.selenium.login.SCoupangCafeLoginDto;
import com.coupang.selenium.page.SCoupangCafePageDto;
import com.coupang.utils.ProductUtils;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class CoupangCafe24Service {

	private static final int BATCH_SIZE = 1000;

	private final CoupangRepository coupangRepository;
	private final CoupangItemsRepository coupangItemsRepository;
	private final CoupangImagesRepository coupangImagesRepository;
	private final CoupangAttributesRepository coupangAttributesRepository;
	private final CoupangDetailsRepository coupangDetailsRepository;
	private final CoupangContentsRepository coupangContentsRepository;

	private final CoupangUserItemsStatusRepository coupangUserItemsStatusRepository;
	
	private final CoupangApiKeyRepository coupangApiKeyRepository;
	
	private final CoupangProductClient coupangProductClient;
	
	@Value("${file.detail-dir}")
	private String detailDir;

	@Value("${file.thmb-dir}")
	private String thmbDir;

	public void loginUrl(String username, String password, String url, int startPage, int endPage)
			throws InterruptedException, IOException {
		EdgeOptions options = new EdgeOptions();
	    options.addArguments("--start-maximized"); // 브라우저 창 최대화
//		options.addArguments("--headless"); // 브라우저 창 숨김
//		options.addArguments("--disable-gpu"); // GPU 비활성화
//		options.addArguments("--inprivate"); // InPrivate 모드

		WebDriver driver = new EdgeDriver(options);

//	    CustomWebDriverListener eventListener = new CustomWebDriverListener(baseDriver);
//	    EventFiringDecorator<WebDriver> decorator = new EventFiringDecorator<>(eventListener);
		// 로그인 실행
		SCoupangCafeLoginDto login = new SCoupangCafeLoginDto(driver);
		
		login.click(username, password, url);

		productPage(driver, username, password, url, startPage, endPage);

		driver.quit();
	}

	private void productPage(WebDriver driver, String username, String password, String companyUrl, int startPage,
			int endPage) throws InterruptedException, IOException {

		SCoupangCafePageDto page = new SCoupangCafePageDto(driver);
		List<String> urls = page.productNextPage(startPage, endPage);

		List<Coupang> coupangList = new ArrayList<>();
		List<CoupangItems> itemsList = new ArrayList<>();
		List<CoupangImages> imagesList = new ArrayList<>();
		List<CoupangContents> contentsList = new ArrayList<>();
		List<CoupangDetails> detailsList = new ArrayList<>();
		List<CoupangAttributes> attributesList = new ArrayList<>();
		for (String url : urls) {
			driver.navigate().to(url);
			URL host = new URL(url);
			String hostUrl = host.getHost();
			
			SCoupangCafeDto dto = new SCoupangCafeDto(driver);
			FluentWait<WebDriver> wait = dto.getFluentWait(50);

			wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector("#title, #goods_spec > form > div.info_name.bootstrap")));
			wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector("#mainImg > li > span > img, #objImg")));

			String pageSource = driver.getPageSource();
			Document doc = Jsoup.parse(pageSource);
			CoupangJsoupInfoDto jsoupDto = new CoupangJsoupInfoDto(hostUrl);
			Map<String, String> selectors = jsoupDto.getSelectors();

		    Element titleElement = doc.selectFirst(selectors.get("title"));
		    Element productCodeElement = doc.selectFirst(selectors.get("productCode"));
		    Elements selectBoxElements = doc.select(selectors.get("selectBox"));
		    Element priceElement = doc.selectFirst(selectors.get("price"));
		    String text = priceElement.text();
		    String price = (text == null || text.isEmpty()) ? priceElement.val() : text;
		    if (titleElement != null) {
		        jsoupDto.cleanTitleAndExtractBrand(titleElement);
		    }

		    String codeText = productCodeElement.text();
		    String code = (codeText != null && !codeText.trim().isEmpty())
		        ? codeText
		        : productCodeElement.val();
		    String title = jsoupDto.getTitle();
		    String brand = jsoupDto.getBrand();
		    
		    String makeCompany = jsoupDto.getSelectors().get("makeCompany");

		    int convertedPrice = ProductUtils.productPriceConverter(price);
		    Integer existCode = coupangRepository.existsByProductCode(code, titleElement.val());
		    
		    if (existCode == null || existCode == 0) {
		        StringBuilder sbDetailFileName = new StringBuilder();
		        String iframeUrl = dto.getIframeUrls(doc, new StringBuilder());
		        String thmbUrl = dto.getThmbImageUrls(new StringBuilder(), thmbDir,wait);

		        JavascriptExecutor js = (JavascriptExecutor) driver;
		        js.executeScript("window.scrollBy(0, 500);");

		        String detailUrl = dto.getDetailImageUrls(new StringBuilder(), detailDir,wait);
		        String deliveryInformation = dto.getDeliveryInformation(new StringBuilder());

		        sbDetailFileName.append("<p align='center'>")
		                .append(iframeUrl)
		                .append(detailUrl)
		                .append(deliveryInformation)
		                .append("</p>");
		        
		        String selectBoxEnabled = "F|".repeat(selectBoxElements.size());
		        CoupangCreateDto coupangCreateDto = CoupangCreateDto.builder()
		                .sellerProductName(title)
		                .vendorId("A00962060")
		                .displayProductName(title)
		                .saleStartedAt("2024-01-19T00:00:00")
		                .saleEndedAt("2099-01-19T00:00:00")
		                .deliveryMethod("SEQUENCIAL")
		                .deliveryCompanyCode("EPOST")
		                .deliveryChargeType("NOT_FREE")
		                .deliveryCharge(3000)
		                .freeShipOverAmount(30000)
		                .deliveryChargeOnReturn(3000)
		                .remoteAreaDeliverable("N")
		                .unionDeliveryType("NOT_UNION_DELIVERY")
		                .returnCenterCode("1001694769")
		                .returnChargeName("경기도 안산시 상록구 충장로 565 111동1203호")
		                .companyContactNumber("010-8900-6085")
		                .returnZipCode("15287")
		                .returnAddress("경기도 안산시 상록구 충장로 565")
		                .returnAddressDetail("111동1203호")
		                .returnCharge(3000)
		                .outboundShippingPlaceCode(19389011)
		                .vendorUserId("qudtn0295")
		                .requested(true)
		                .manufacture(makeCompany)
		                .brand(brand)
		                .productCode(code)
		                .currentUrl(driver.getCurrentUrl())
		                .build();
		        
		        Coupang coupang = CoupangCreateDto.toEntity(coupangCreateDto);
		        coupangList.add(coupang);
		        
		        if (!selectBoxElements.isEmpty()) {
		        	processOptions(doc, selectBoxElements, 0, "", coupang, convertedPrice,
		                    thmbUrl, sbDetailFileName.toString(), selectBoxEnabled,
		                    "", "", "", itemsList, imagesList, contentsList, detailsList, attributesList);

		        } else if (selectBoxEnabled.isEmpty()) {
		            coupangSingleProductSave(coupang, title, convertedPrice, thmbUrl,
		                    sbDetailFileName.toString(), itemsList, imagesList, contentsList, detailsList, attributesList);
		        }
			}
		}
		CoupangProductSave(coupangList, itemsList, imagesList, attributesList, detailsList, contentsList);
	}

	private void coupangSingleProductSave(Coupang coupang, String optionName, int price, String thmb,
			String detailImages, List<CoupangItems> items, List<CoupangImages> images, List<CoupangContents> contents, List<CoupangDetails> details, List<CoupangAttributes> attributes) {

		CoupangItems coupangItem = CoupangItems.builder().coupang(coupang).itemName(optionName).originalPrice(price)
				.salePrice(price).maximumBuyCount(10).maximumBuyForPerson(0).maximumBuyForPersonPeriod(1)
				.outboundShippingTimeDay(3).unitCount(0).adultOnly("EVERYONE").taxType("TAX")
				.parallelImported("NOT_PARALLEL_IMPORTED").overseasPurchased("NOT_OVERSEAS_PURCHASED").pccNeeded(false)
				.build();
		items.add(coupangItem);

		CoupangImages coupangImage = CoupangImages.builder().imageOrder(0).imageType("REPRESENTATION").vendorPath(thmb)
				.coupangItems(coupangItem).coupang(coupang).build();
		images.add(coupangImage);

		CoupangContents coupangContent = CoupangContents.builder().contentsType("TEXT").coupangItems(coupangItem)
				.coupang(coupang).build();
		contents.add(coupangContent);

		CoupangDetails coupangDetail = CoupangDetails.builder().content(detailImages).detailType("TEXT")
				.coupangContents(coupangContent).coupang(coupang).build();
		details.add(coupangDetail);
	}

	public void processOptions(Document doc, Elements selectBoxElements, int index,
	        String combinedOption, Coupang coupang, int convertedPrice,
	        String thumbnail, String detailImages, String selectBoxEnabled,
	        String firstOption, String secondOption, String thirdOption,
	        List<CoupangItems> itemsList,
	        List<CoupangImages> imagesList, List<CoupangContents> contentsList,
	        List<CoupangDetails> detailsList, List<CoupangAttributes> attributesList) {

	    if (index >= selectBoxElements.size()) {
	        handleResults(coupang, combinedOption, convertedPrice, thumbnail, detailImages,
	                selectBoxEnabled, firstOption, secondOption, thirdOption,
	                itemsList, imagesList, contentsList, detailsList, attributesList);
	        return;
	    }

	    Element selectBox = selectBoxElements.get(index);
	    Elements optionElements = selectBox.select("option");
	    Set<String> seenOptions = new HashSet<>();

	    for (Element option : optionElements) {
	        String optionText = option.text().trim();
	        if (optionText.isEmpty() || optionText.contains("품절") || optionText.contains("단종")
	                || optionText.contains("색상") || optionText.contains("-------------------")) {
	            continue;
	        }
	        String newFirst = firstOption, newSecond = secondOption, newThird = thirdOption, newCombined = combinedOption;

	        if (index == 0) {
	            newFirst = optionText;
	            newCombined = newFirst;
	        } else if (index == 1) {
	            newSecond = optionText;
	            newCombined = newFirst + " " + newSecond;
	        } else if (index == 2) {
	            newThird = optionText;
	            newCombined = newFirst + " " + newSecond + " " + newThird;
	        }

	        if (!seenOptions.add(newCombined)) continue;

	        processOptions(doc, selectBoxElements, index + 1, newCombined, coupang, convertedPrice,
	                thumbnail, detailImages, selectBoxEnabled, newFirst, newSecond, newThird,
	                itemsList, imagesList, contentsList, detailsList, attributesList);
	    }
	}

	public void handleResults(Coupang coupang, String combinedOption, int price, String thmb, String detailImages,
			String selectBox, String firstOption, String secondOption, String thirdOption, List<CoupangItems> itemsList,
			List<CoupangImages> imagesList, List<CoupangContents> contentsList, List<CoupangDetails> detailsList,
			List<CoupangAttributes> attributesList) {

		if (selectBox.equals("F|") || selectBox.equals("F|F|") || selectBox.equals("F|F|F|")) {
			CoupangItemsCreateDto coupangItemsDto = CoupangItemsCreateDto.builder().coupangId(coupang.getCoupangId())
					.itemName(combinedOption.trim()).originalPrice(price).salePrice(price).maximumBuyCount(10)
					.maximumBuyForPerson(0).maximumBuyForPersonPeriod(1).outboundShippingTimeDay(3).unitCount(0)
					.adultOnly("EVERYONE").taxType("TAX").parallelImported("NOT_PARALLEL_IMPORTED")
					.overseasPurchased("NOT_OVERSEAS_PURCHASED").pccNeeded(false).build();

			CoupangItems coupangItem = CoupangItemsCreateDto.toEntity(coupangItemsDto, coupang);
			itemsList.add(coupangItem);

			CoupangImagesCreateDto coupangImagesDto = CoupangImagesCreateDto.builder().imageOrder(0)
					.imageType("REPRESENTATION").vendorPath(thmb).coupangItemsId(coupangItem.getItemId())
					.coupangId(coupang.getCoupangId()).build();
			CoupangImages coupangImage = CoupangImagesCreateDto.toEntity(coupangImagesDto, coupang, coupangItem);
			imagesList.add(coupangImage);

			CoupangContentsCreateDto coupangContentDto = CoupangContentsCreateDto.builder().contentsType("TEXT")
					.coupangItemsId(coupangItem.getItemId()).coupangId(coupang.getCoupangId()).build();
			CoupangContents coupangContent = CoupangContentsCreateDto.toEntity(coupangContentDto, coupang, coupangItem);
			contentsList.add(coupangContent);

			CoupangDetails coupangDetailDto = CoupangDetails.builder().content(detailImages).detailType("TEXT")
					.coupangContents(coupangContent).coupang(coupang).build();
			CoupangDetails coupangDetail = CoupangDetailsCreateDto.toEntity(coupangDetailDto, coupang, coupangContent);
			detailsList.add(coupangDetail);

			if (selectBox.equals("F|")) {
				CoupangAttributesCreateDto attributesDto = CoupangAttributesCreateDto.builder().attributeTypeName("옵션")
						.attributeValueName(firstOption).coupangId(coupang.getCoupangId())
						.coupangItemsId(coupangItem.getItemId()).build();

				CoupangAttributes coupangAttribute = CoupangAttributesCreateDto.toEntity(attributesDto, coupang,
						coupangItem);

				attributesList.add(coupangAttribute);
			} else if (selectBox.equals("F|F|") && !combinedOption.isEmpty()) {
				CoupangAttributesCreateDto attributesDto = CoupangAttributesCreateDto.builder().attributeTypeName("옵션")
						.attributeValueName(secondOption).coupangId(coupang.getCoupangId())
						.coupangItemsId(coupangItem.getItemId()).build();
				CoupangAttributes coupangAttribute = CoupangAttributesCreateDto.toEntity(attributesDto, coupang,
						coupangItem);

				CoupangAttributesCreateDto attributesDto2 = CoupangAttributesCreateDto.builder()
						.attributeTypeName("옵션2").attributeValueName(firstOption).coupangId(coupang.getCoupangId())
						.coupangItemsId(coupangItem.getItemId()).build();
				CoupangAttributes coupangAttribute2 = CoupangAttributesCreateDto.toEntity(attributesDto2, coupang,
						coupangItem);

				attributesList.add(coupangAttribute);
				attributesList.add(coupangAttribute2);
			} else if (selectBox.equals("F|F|F|") && !combinedOption.isEmpty()) {
				CoupangAttributesCreateDto attributesDto = CoupangAttributesCreateDto.builder().attributeTypeName("옵션")
						.attributeValueName(secondOption).coupangId(coupang.getCoupangId())
						.coupangItemsId(coupangItem.getItemId()).build();
				CoupangAttributes coupangAttribute = CoupangAttributesCreateDto.toEntity(attributesDto, coupang,
						coupangItem);

				CoupangAttributesCreateDto attributesDto2 = CoupangAttributesCreateDto.builder()
						.attributeTypeName("옵션2").attributeValueName(firstOption).coupangId(coupang.getCoupangId())
						.coupangItemsId(coupangItem.getItemId()).build();
				CoupangAttributes coupangAttribute2 = CoupangAttributesCreateDto.toEntity(attributesDto2, coupang,
						coupangItem);

				CoupangAttributesCreateDto attributesDto3 = CoupangAttributesCreateDto.builder()
						.attributeTypeName("옵션3").attributeValueName(thirdOption).coupangId(coupang.getCoupangId())
						.coupangItemsId(coupangItem.getItemId()).build();

				CoupangAttributes coupangAttribute3 = CoupangAttributesCreateDto.toEntity(attributesDto3, coupang,
						coupangItem);
				attributesList.add(coupangAttribute);
				attributesList.add(coupangAttribute2);
				attributesList.add(coupangAttribute3);
			}
		}
	}

	@Transactional
	public void CoupangProductSave(List<Coupang> coupangList, List<CoupangItems> items, List<CoupangImages> images,
			List<CoupangAttributes> attributes, List<CoupangDetails> details, List<CoupangContents> contents) {
		coupangRepository.saveAll(coupangList);
		coupangItemsRepository.saveAll(items);
		coupangImagesRepository.saveAll(images);
		coupangContentsRepository.saveAll(contents);
		coupangDetailsRepository.saveAll(details);
		coupangAttributesRepository.saveAll(attributes);
	}

	public void getCoupangInventory(String username, String password, String url, int startPage, int endPage,
			String brandUrl, Long id) throws InterruptedException {
		SeleniumSessionManager sessionManager = new SeleniumSessionManager(username, password, url);

	    productInventoryPage(sessionManager, username, password, url, startPage, endPage, brandUrl, id);

	    sessionManager.quitDriver();
	}

	private void productInventoryPage(SeleniumSessionManager sessionManager, String username, String password, String url, int startPage,
	        int endPage, String brandUrl, Long id) throws InterruptedException {

	    System.out.println(brandUrl);
	    PageRequest pageRequest = PageRequest.of(40, 80);
	    List<Coupang> coupangStockList = coupangRepository.findAllByBrandAndSendYn(brandUrl,pageRequest);

	    List<CoupangStocksDto> soldOutList = new ArrayList<>();
	    List<CoupangStocksDto> inStockList = new ArrayList<>();
	    List<CoupangItems> itemsToUpdate = new ArrayList<>();
	    WebDriver driver = sessionManager.getDriver();
	    for (Coupang coupang : coupangStockList) {
	        try {
	            
	            driver.navigate().to(coupang.getCurrentUrl());
	            Thread.sleep(2000);
	            if (!sessionManager.isSessionValid()) {
	                System.err.println("[세션 만료 감지] 드라이버 재시작");
	                sessionManager.restartDriver();
	                driver = sessionManager.getDriver();  // 재할당
	            }

	            Document doc = Jsoup.parse(driver.getPageSource());

	            CoupangJsoupInfoDto jsoupDto = new CoupangJsoupInfoDto(brandUrl);
	            jsoupDto.cleanTitleAndExtractBrand(doc.selectFirst(jsoupDto.getSelector("title")));

	            Element productCodeElement = doc.selectFirst(jsoupDto.getSelector("productCode"));
	            String productCode = "";
	            if (productCodeElement != null) {
	                productCode = productCodeElement.hasAttr("value") ? productCodeElement.val() : productCodeElement.text();
	                if (productCode == null || productCode.isBlank()) productCode = "";
	                productCode = productCode.trim();
	            }
	            jsoupDto.setProductCode(productCode);

	            boolean isSoldOut = jsoupDto.checkSoldOut(doc);
	            Elements selectBoxes = doc.select(jsoupDto.getSelector("selectBox"));
	            System.out.println(isSoldOut); 
	            processStockOptions(driver, doc, selectBoxes, 0, "", coupang, productCode,
	                    soldOutList, inStockList, itemsToUpdate, isSoldOut);

	        } catch (UnhandledAlertException e) {
	            try {
	                Alert alert = sessionManager.getDriver().switchTo().alert();
	                String alertText = alert.getText();
	                alert.accept();

	                if (alertText.contains("상품정보가 존재하지 않습니다")) {
	                    CoupangStocksDto stockDto = CoupangStocksCreateDto.builder()
	                            .productCode(coupang.getProductCode())
	                            .itemName("")
	                            .build()
	                            .toDto();
	                    soldOutList.add(stockDto);
	                    continue;
	                }

	            } catch (NoAlertPresentException ignored) {
	                System.out.println(ignored.getMessage());
	            }

	        } catch (NoSuchSessionException | TimeoutException e) {
	            System.err.println("[세션 문제] 재시작: " + e.getMessage());
	            sessionManager.restartDriver();
	            Thread.sleep(2000); 
	            continue;          
	        } catch (Exception e) {
	            System.err.println("[예외 발생] " + e.getMessage());
	        }
	    }
	    System.out.println("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@");
	    for(CoupangStocksDto dto: soldOutList) {
	    	System.out.println("=============================");
	    	System.out.println(dto.getItemName());
	    	System.out.println(dto.getProductCode());
	    	System.out.println("=============================");
	    }
	    System.out.println("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@");
	    
	    updateCoupangStockStatus(soldOutList, coupangStockList, id, 0);
//	    updateCoupangStockStatus(inStockList, coupangStockList, id, 999);
	}


	private void processStockOptions(WebDriver driver, Document doc, Elements selectBoxes, int index,
	        String combinedOption, Coupang coupang, String productCode,
	        List<CoupangStocksDto> soldOutList, List<CoupangStocksDto> inStockList,
	        List<CoupangItems> itemsToUpdate, boolean isSoldOut) {

	    if (index >= selectBoxes.size()) {
	        CoupangStocksCreateDto stockCreateDto = CoupangStocksCreateDto.builder()
	                .productCode(productCode)
	                .itemName(combinedOption)
	                .build();

	        CoupangStocksDto stockDto = stockCreateDto.toDto();

	        if (combinedOption.contains("품절") || combinedOption.contains("단종") || isSoldOut) {
	            soldOutList.add(stockDto);
	        } else {
	            inStockList.add(stockDto);
	        }
	        return;
	    }

	    Element selectBox = selectBoxes.get(index);
	    Elements optionElements = selectBox.select("option");
	    Set<String> seenOptions = new HashSet<>();

	    for (Element option : optionElements) {
	        String optionText = option.text().trim();
	        if (optionText.isEmpty() || optionText.contains("품절") || optionText.contains("단종")
	                || optionText.contains("색상") || optionText.contains("-------------------")) {
	            continue;
	        }

	        String newCombinedOption = combinedOption.isEmpty() ? optionText : combinedOption + " " + optionText;

	        if (!seenOptions.add(newCombinedOption)) {
	            continue;
	        }

	        processStockOptions(driver, doc, selectBoxes, index + 1, newCombinedOption,
	                coupang, productCode, soldOutList, inStockList, itemsToUpdate, isSoldOut);
	    }
	}

	@Transactional
	public void updateCoupangStockStatus(List<CoupangStocksDto> stocks, List<Coupang> coupangStockLists, Long id, int quantity) {
	    CoupangApiKey apiKey = coupangApiKeyRepository.findByCoupangUser_Id(id)
	        .orElseThrow(() -> new IllegalArgumentException("API Key가 존재하지 않습니다. User ID: " + id));

	    List<CoupangUserItemsStatus> itemsToSaveStatus = new ArrayList<>();

	    for (CoupangStocksDto stock : stocks) {
	        String productCode = stock.getProductCode();
	        String itemName = cleanItemName(stock.getItemName());

	        List<CoupangItemStatusDTO> itemsToUpdate = getItemsToUpdate(productCode, itemName, quantity);

	        for (CoupangItemStatusDTO dto : itemsToUpdate) {
	            CoupangApiDetailResponse detailResponse = coupangProductClient.detailDataToCoupang(
	                dto.getCoupangProductId(), apiKey.getAccessKey(), apiKey.getSecretKey());

	            Optional<CoupangDetailItemResponse> matchedItem = findMatchingItem(detailResponse, dto, itemName);

	            if (matchedItem.isEmpty()) {
	                System.out.println("[DEBUG] 매칭되는 item 없음: productCode=" + productCode + ", itemName=" + itemName);
	                continue;
	            }

	            CoupangDetailItemResponse item = matchedItem.get();
	            System.out.println("???????????????"+dto.getItemId());
	            Optional<CoupangUserItemsStatus> userItemOpt = coupangUserItemsStatusRepository.findByItemsId(dto.getItemId());
	            if (userItemOpt.isEmpty()) {
	                System.out.println("[DEBUG] 존재하지 않는 itemId: " + dto.getItemId());
	                continue;
	            }

	            CoupangUserItemsStatus userItem = userItemOpt.get();

	            userItem.setVendorItemId(item.getVendorItemId());
	            userItem.setQuantity(dto.getQuantity());
	            itemsToSaveStatus.add(userItem);
	        }
	    }

	    if (!itemsToSaveStatus.isEmpty()) {
	        coupangUserItemsStatusRepository.saveAll(itemsToSaveStatus);
	    }
	}

	private String cleanItemName(String rawName) {
	    return (rawName == null) ? "" : rawName.replaceAll("\\(품절\\)|\\(단종\\)", "").trim();
	}

	private List<CoupangItemStatusDTO> getItemsToUpdate(String productCode, String itemName, int quantity) {
	    boolean isOption = (itemName != null && !itemName.isBlank());

	    if (isOption) {
	        return (quantity == 0)
	            ? coupangItemsRepository.findAllByProductCodeAndItemName(productCode, itemName)
	            : coupangItemsRepository.findItemsForStatusCheck(productCode, itemName);
	    } else {
	        return (quantity == 0)
	            ? coupangItemsRepository.findAllByProductCode(productCode)
	            : coupangItemsRepository.findItemsForStatusCheck(productCode);
	    }
	}

	private Optional<CoupangDetailItemResponse> findMatchingItem(CoupangApiDetailResponse response, CoupangItemStatusDTO dto, String itemName) {
	    System.out.println("[DEBUG] itemName from DB: '" + itemName + "'");
	    System.out.println("[DEBUG] dto.getCoupangProductId() = " + dto.getCoupangProductId());

	    for (CoupangDetailItemResponse item : response.getItemList()) {
	        System.out.println("[DEBUG] API itemName: '" + item.getItemName() + "', productId: " + item.getSellerProductId());
	    }

	    if (itemName == null || itemName.isBlank()) {
	        return response.getItemList().stream()
	            .filter(item -> item.getSellerProductId().equals(dto.getCoupangProductId()))
	            .findFirst();
	    } else {
	        return response.getItemList().stream()
	            .filter(item -> item.getItemName().contains(itemName) &&
	                            item.getSellerProductId().equals(dto.getCoupangProductId()))
	            .findFirst();
	    }
	}
	
	@Transactional
	public String deleteInventory(long id, long productSellerId, long coupangUserId) throws InterruptedException {
	    CoupangApiKey apiKey = coupangApiKeyRepository.findByCoupangUser_Id(coupangUserId)
	        .orElseThrow(() -> new IllegalArgumentException("API Key가 존재하지 않습니다. User ID: " + coupangUserId));

	    CoupangApiDetailResponse detailResponse = coupangProductClient.detailDataToCoupang(
	        productSellerId, apiKey.getAccessKey(), apiKey.getSecretKey());

	    List<CoupangDetailItemResponse> itemList = Optional.ofNullable(detailResponse.getItemList())
	        .orElse(Collections.emptyList());

	    if (!itemList.isEmpty()) {
	        CoupangDetailItemResponse item = itemList.get(0);  // 첫 번째 아이템을 가져오기 위해 get(0) 사용

	        if (item.getVendorItemId() == 0) {
	            CoupangDeleteProductResponse deleteResponse = coupangProductClient.deleteDataToCoupang(
	                productSellerId, apiKey.getAccessKey(), apiKey.getSecretKey());

	            if ("SUCCESS".equals(deleteResponse.getCode())) {
	                coupangRepository.deleteById(id);
	                return deleteResponse.getMessage();
	            } else {
	                return "상품 삭제 실패: " + deleteResponse.getMessage();
	            }
	        }

	        List<Long> vendorItemIds = itemList.stream()
	            .map(CoupangDetailItemResponse::getVendorItemId)
	            .filter(Objects::nonNull)
	            .collect(Collectors.toList());

	        List<String> itemNames = itemList.stream()
	            .map(CoupangDetailItemResponse::getItemName)
	            .filter(Objects::nonNull)
	            .collect(Collectors.toList());

	        List<CoupangUserItemsStatus> existingItems = coupangUserItemsStatusRepository.findBySellerProductIdAndVendorIdAndItemNames(
	            productSellerId, itemNames);

	        if (existingItems.isEmpty()) {
	            return "삭제할 재고 데이터가 없습니다.";
	        }

	        existingItems.forEach(existingItem ->
	            itemList.stream()
	                .filter(responseItem -> responseItem.getItemName().equals(existingItem.getItemName()) &&
	                                        responseItem.getSellerProductId().equals(existingItem.getCoupangProductId()))
	                .findFirst()
	                .ifPresent(responseItem -> existingItem.setVendorItemId(responseItem.getVendorItemId()))
	        );

	        List<Integer> results = vendorItemIds.stream()
	            .map(vendorItemId -> coupangProductClient.updateDataToCoupang(vendorItemId, apiKey.getAccessKey(), apiKey.getSecretKey()))
	            .collect(Collectors.toList());

	        if (results.stream().allMatch(code -> code == 200)) {
	            coupangUserItemsStatusRepository.saveAll(existingItems);

	            CoupangDeleteProductResponse deleteResponse = coupangProductClient.deleteDataToCoupang(
	                productSellerId, apiKey.getAccessKey(), apiKey.getSecretKey());

	            if ("SUCCESS".equals(deleteResponse.getCode())) {
	                coupangRepository.deleteById(id);
	                return deleteResponse.getMessage();
	            }
	        } else {
	            return "판매 중지 실패: 일부 항목에서 오류 발생";
	        }
	    }

	    return "삭제할 상품이 존재하지 않습니다.";
	}
	
}