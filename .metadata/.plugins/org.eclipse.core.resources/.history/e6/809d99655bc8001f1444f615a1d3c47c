package com.shop.selenium.dto;

import java.time.Duration;
import java.util.ArrayList;
import java.util.List;

import org.openqa.selenium.By;
import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.FindAll;
import org.openqa.selenium.support.FindBy;
import org.openqa.selenium.support.PageFactory;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import com.shop.Coupang;

import lombok.Getter;
import lombok.NoArgsConstructor;

@Getter@NoArgsConstructor
public class SCoupangStockSearchDto {
	private WebDriver driver;
    
    @FindAll({
        @FindBy(css = "#searchBoxContainer > div > form > input"),
        @FindBy(css = "#searchBoxContainerMobile > sip-page-slot > div > form > input")
    })
    private WebElement searchTitle;
    
    @FindAll({
        @FindBy(css = "body > main > div.page-content.container.main-wrapper > sip-product-listing > div.col-sm-9.search-page-container.ng-star-inserted > div > sip-product-search-results > sip-page-slot > sip-product-list > div > section > div.ng-star-inserted > div > ul > sip-product-list-item > li"),
    })
    private List<WebElement> searchResult;

//    @FindAll({
//    	@FindBy(css = "body > main > div.page-content.container.main-wrapper > sip-product-listing > div.col-sm-9.search-page-container.ng-star-inserted > div > sip-product-search-results > sip-page-slot > sip-product-list > div > section > div.ng-star-inserted > div > ul > sip-product-list-item > li > div.product-image > div > div")
//    })
//    private WebElement productSoldOutResult;
 
    private List<String> soldOut; 
    
    public SCoupangStockSearchDto(WebDriver driver) {
        this.driver = driver;
        PageFactory.initElements(driver, this);
    }
    
    public void search(Coupang coupang) {
		WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(50));
    	WebElement title = wait.until(ExpectedConditions.visibilityOf(searchTitle));
    	title.sendKeys(coupang.getProductCode());
    	title.submit();
    	title.clear();
//    	WebElement result = wait.until(ExpectedConditions.visibilityOf(searchResult));
    	
    	try {
            // 제품 리스트에서 품절되지 않은 제품의 URL을 추출
            for (WebElement product : searchResult) {
                try {
//                    product.findElement(By.cssSelector("div > a, div > div > a"));
                    boolean isSoldOut = checkIfSoldOut(product); // 품절 여부 확인
                    if (isSoldOut) {
//                        String url = anchorTag.getAttribute("href");
                        soldOut.add(coupang.getProductCode()); // 품절되지 않은 경우 URL 추가
                    }
                } catch (NoSuchElementException e) {
                    System.out.println("요소를 찾을 수 없습니다. 계속 진행합니다." + e.getMessage());
                }
            }
        } catch (NoSuchElementException e) {
            System.out.println("페이지에서 요소를 찾을 수 없습니다: " + e.getMessage());
        }
    	System.out.println(soldOut.size());
    	
    }
    
    private boolean checkIfSoldOut(WebElement productElement) {
        try {
            List<WebElement> soldOutIcons = productElement.findElements(By.cssSelector("div > img, div.product-image > div > div"));

            for (WebElement icon : soldOutIcons) {
                String altValue = icon.getAttribute("alt");
                // 품절을 나타내는 alt 값이 있는지 체크
                if (altValue != null && altValue.contains("품절")) {
                    return true; // 품절 이미지가 있는 경우
                }
                
                String divValue = icon.getText(); // div 내부 텍스트
                if (divValue != null && divValue.contains("품절")) {
                    return true; // div 텍스트에 "품절"이 포함된 경우
                }
            }
            return false; // 품절 이미지가 없는 경우
        } catch (NoSuchElementException e) {
            return false; 
        }
    }
}
