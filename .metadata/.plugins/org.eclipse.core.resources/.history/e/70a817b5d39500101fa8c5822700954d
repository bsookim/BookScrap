package com.coupang.scrap.view;

import java.time.Duration;
import java.util.*;
import java.util.concurrent.*;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.openqa.selenium.*;
import org.openqa.selenium.support.ui.WebDriverWait;

import com.coupang.ai.OpenAiClient;
import com.coupang.cloudflare.CloudflareImageUploader;
import com.coupang.entity.Coupang;
import com.coupang.factory.CoupangRequestList;
import com.coupang.repository.CoupangRepository;
import com.coupang.scrap.dto.CoupangItemRequestDto;
import com.coupang.scrap.helper.CoupangRequestListHelper;
import com.coupang.scrap.task.AiTitleOptimizationTask;
import com.coupang.scrap.task.ImageUploadTask;
import com.coupang.utils.PriceUtils;

public class EchobelleProductViewHandler implements ProductViewHandler {

    public CoupangRequestList handleRows(WebDriver driver, List<WebElement> rows, CoupangRepository repository) {
        CoupangRequestList requestList = new CoupangRequestList();
        String mainWindow = driver.getWindowHandle();
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));

//        ExecutorService rowExecutor = Executors.newFixedThreadPool(Math.min(8, rows.size()));
//        List<Future<CoupangRequestList>> futures = new ArrayList<>();
        System.out.println("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@");
        System.out.println(rows.size());
//        for (WebElement row : rows) {
//            futures.add(rowExecutor.submit(() -> processRow(driver, row, repository, wait, mainWindow)));
//        }
//
//        for (Future<CoupangRequestList> f : futures) {
//            try {
//                CoupangRequestList r = f.get();
//                if (r != null) requestList.merge(r);
//            } catch (Exception e) {
//                e.printStackTrace();
//            }
//        }
//
//        rowExecutor.shutdown();
//        try {
//            if (!rowExecutor.awaitTermination(60, TimeUnit.SECONDS)) {
//                rowExecutor.shutdownNow();
//            }
//        } catch (InterruptedException e) {
//            rowExecutor.shutdownNow();
//        }
//
        return requestList;
    }

    private CoupangRequestList processRow(WebDriver driver, WebElement row, CoupangRepository repository,
                                           WebDriverWait wait, String mainWindow) {
        CoupangRequestList tempList = new CoupangRequestList();

        try {
            // === HTML 파싱(JSoup) ===
            String rowHtml = row.getAttribute("outerHTML");
            Document doc = Jsoup.parse(rowHtml);

            // ListCode, 타이틀, 상품코드
            Element codeTd = doc.selectFirst("td.list-code");
            if (codeTd == null) return tempList;

            String listCodeText = codeTd.html().replaceAll("(?i)<br\\s*/?>", "\n").trim();
            String title = extractTitle(listCodeText);
            String productCode = extractProductCode(listCodeText);
            if (productCode.isEmpty()) return tempList;
            System.out.println(title);
            System.out.println(productCode);
            // 재고 확인
            Element stockTd = doc.selectFirst("td.list-jg");
            if (stockTd == null) return tempList;
            String stockInfo = stockTd.text().replaceAll("\\s+", "");
            if (stockInfo.contains("품절")) return tempList;

            // 중복 체크
            if (repository.existsByProductCode(productCode) != null) return tempList;

            // 가격 및 썸네일
            int sellingPrice = PriceUtils.parsePrice(doc.selectFirst("td.list-p2").text());
            int consumerPrice = PriceUtils.parsePrice(doc.selectFirst("td.list-p1").text());
            String thumbnailUrl = doc.selectFirst("td.list-img1 img").attr("src");

            // 상세페이지 접근(Selenium)
            WebElement aTag = row.findElement(By.cssSelector("td.list-img2 a"));
            Set<String> beforeClick = driver.getWindowHandles();
            ((JavascriptExecutor) driver).executeScript("arguments[0].click();", aTag);

            Set<String> afterClick = driver.getWindowHandles();
            afterClick.removeAll(beforeClick);
            if (afterClick.isEmpty()) return tempList;

            String detailWindow = afterClick.iterator().next();
            driver.switchTo().window(detailWindow);

            wait.until(d -> !driver.findElements(By.cssSelector("center img")).isEmpty());
            List<String> detailImageUrls = driver.findElements(By.cssSelector("center img")).stream()
                    .map(img -> img.getAttribute("src"))
                    .filter(src -> src != null && !src.isEmpty())
                    .collect(Collectors.toList());

            Map<String, List<String>> imagesToUpload = new HashMap<>();
            imagesToUpload.put("thumbnail", List.of(thumbnailUrl));
            imagesToUpload.put("detailImage", detailImageUrls);

            CompletableFuture<Map<String, List<String>>> uploadFuture = new ImageUploadTask(imagesToUpload).executeAsync();
            CompletableFuture<String> aiTitleFuture = new AiTitleOptimizationTask(title, new OpenAiClient()).executeAsync();

            Map<String, List<String>> uploadedImages = uploadFuture.join();
            String aiTitle = aiTitleFuture.join();

            Coupang coupang = CoupangRequestListHelper.addCoupangToList(
                    tempList, title, aiTitle, productCode, driver.getCurrentUrl(), "", ""
            );

            CoupangItemRequestDto dto = CoupangItemRequestDto.builder()
                    .coupang(coupang)
                    .itemTitle(title)
                    .sellingPrice(sellingPrice)
                    .consumerPrice(consumerPrice)
                    .quantity(10)
                    .thumbnailImages(uploadedImages.get("thumbnail"))
                    .detailImages(uploadedImages.getOrDefault("detailImage", List.of()))
                    .optionValues(List.of())
                    .build();

            CoupangRequestListHelper.addItemFromDto(tempList, dto);

            driver.close();
            driver.switchTo().window(mainWindow);

        } catch (Exception e) {
            try { driver.switchTo().window(mainWindow); } catch (Exception ignored) {}
        }

        return tempList;
    }

    private String extractTitle(String listCodeText) {
        return (listCodeText == null || listCodeText.isBlank())
                ? ""
                : listCodeText.replaceAll("\\s*\\([^)]*\\)\\s*$", "").trim();
    }

    private String extractProductCode(String listCodeText) {
        if (listCodeText == null || listCodeText.isBlank()) return "";
        Matcher matcher = Pattern.compile("\\(([^()\\s]+)\\)\\s*$").matcher(listCodeText.trim());
        return matcher.find() ? matcher.group(1).trim() : "";
    }
}
