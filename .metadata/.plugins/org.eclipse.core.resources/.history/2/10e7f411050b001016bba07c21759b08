package com.coupang.hamc;

import org.apache.http.HttpEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import org.json.JSONObject;
import org.springframework.stereotype.Component;

import com.coupang.entity.Coupang;
import com.coupang.entity.CoupangItems;
import com.coupang.entity.CoupangUser;
import com.coupang.entity.CoupangUserItemsStatus;
import com.coupang.openapi.sdk.Hmac;
import com.coupang.repository.CoupangItemsRepository;
import com.coupang.repository.CoupangRepository;
import com.coupang.repository.CoupangUserItemsStatusRepository;
import com.coupang.repository.CoupangUserRepository;

import org.springframework.transaction.annotation.Transactional;
import lombok.RequiredArgsConstructor;

import org.apache.http.client.entity.EntityBuilder;
import org.apache.http.client.utils.URIBuilder;

import java.net.URI;
import java.util.ArrayList;
import java.util.List;

@Component
@RequiredArgsConstructor
public class HmacProductCreation {
	
	private final CoupangUserItemsStatusRepository coupangUserItemsStatusRepository; 
    private final CoupangUserRepository coupangUserRepository;
	private final CoupangItemsRepository coupangItemsRepository;
	private final CoupangRepository coupangRepository;
	private static final String HOST = "api-gateway.coupang.com";
    private static final int PORT = 443;
    private static final String SCHEMA = "https";
    private static final String ACCESS_KEY = "f20949fb-c3f6-417a-a357-94d4e6f405d6";
    private static final String SECRET_KEY = "0d4263d854b749ba1742a44d8223c7bf6854d5cc";
    
    public void sendDataToCoupang(String jsonPayload, Long coupangId, List<Long> coupangItemsId, Long userId) {
        String method = "POST";
        String path = "/v2/providers/seller_api/apis/api/v1/marketplace/seller-products";

        try (CloseableHttpClient client = HttpClients.createDefault()) {
            URI uri = new URIBuilder()
                    .setScheme(SCHEMA)
                    .setHost(HOST)
                    .setPort(PORT)
                    .setPath(path)
                    .build();
            URIBuilder uriBuilder = new URIBuilder()
                    .setPath(path);
            String authorization = Hmac.generate(method, uriBuilder.build().toString(), SECRET_KEY, ACCESS_KEY);

            HttpPost requestPost = new HttpPost(uri);
            requestPost.addHeader("Authorization", authorization);
            requestPost.addHeader("Content-Type", "application/json");
            requestPost.setEntity(EntityBuilder
			            		.create()
			            		.setText(jsonPayload)
			            		.setContentType(org.apache.http.entity.ContentType.APPLICATION_JSON)
			            		.build());
            
	        try (CloseableHttpResponse response = client.execute(requestPost)) {
	        	  System.out.println("status code: " + response.getStatusLine().getStatusCode());
	              System.out.println("status message: " + response.getStatusLine().getReasonPhrase());
	
	              HttpEntity entity = response.getEntity();
	              String responseBody = EntityUtils.toString(entity);
	              System.out.println("result: " + responseBody);
	              
	              JSONObject jsonObj = new JSONObject(responseBody);
	              if (jsonObj.has("code") && "SUCCESS".equals(jsonObj.getString("code"))) {
	                  long coupangProductId = jsonObj.getLong("data");
	                  System.out.println(coupangProductId);
	                  saveProudctCoupnagId(coupangId, coupangProductId, coupangItemsId, userId);
	                  saveCoupangProductSellerId(coupangId,coupangProductId);
	              } else {
	                  System.out.println("Operation was not successful");
	              }
	              
	       	}
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Transactional
	public void saveProudctCoupnagId(Long coupangId, long coupangProductId, List<Long> coupangItemsId, Long userId) {
    	CoupangUser coupangUserId = coupangUserRepository.findById((long) userId)
    	        .orElseThrow(() -> new IllegalArgumentException("쿠팡 유저 번호가 없음=" + userId));

	    List<CoupangItems> coupangItemsList = coupangItemsRepository.findAllByItemIdsAndCoupangId(coupangItemsId, coupangId);
	    if (coupangItemsList.isEmpty()) {
	        throw new IllegalArgumentException("쿠팡 아이템이 존재하지 않습니다. coupangId=" + coupangId);
	    }

	    List<CoupangUserItemsStatus> list = new ArrayList<>();
	    for (CoupangItems coupangItems : coupangItemsList) {
	    	CoupangUserItemsStatus coupangUserItemsStatus = CoupangUserItemsStatus.builder()
	    		    .coupangItems(coupangItems)
	    		    .coupangUser(coupangUserId)
	    		    .coupangProductId(coupangProductId)
	    		    .sendYn("Y")
	    		    .coupang(coupangItems.getCoupang())
	    		    .build();
	        list.add(coupangUserItemsStatus);
	    }

	    coupangUserItemsStatusRepository.saveAll(list);
	}
    
    @Transactional
    private void saveCoupangProductSellerId(long coupangId,long coupangProductId) {
    	Coupang existingCoupang = coupangRepository.findById(coupangId)
    	        .orElseThrow(() -> new IllegalArgumentException("쿠팡 번호가 없음=" + coupangId));

    	Coupang updatedCoupang = existingCoupang.toBuilder()
    	        .sellerProductId(coupangProductId) 
    	        .build();

    	coupangRepository.save(updatedCoupang);
    }
    
}
