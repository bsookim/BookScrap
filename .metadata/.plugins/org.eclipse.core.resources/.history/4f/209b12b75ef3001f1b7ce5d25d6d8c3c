package com.shop.service;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.time.Duration;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Set;
import java.util.concurrent.ThreadLocalRandom;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

import org.hibernate.internal.build.AllowSysOut;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.openqa.selenium.By;
import org.openqa.selenium.Cookie;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.NoSuchElementException;
import java.util.Collection;

import org.openqa.selenium.StaleElementReferenceException;
import org.openqa.selenium.TimeoutException;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.edge.EdgeDriver;
import org.openqa.selenium.edge.EdgeOptions;
import org.openqa.selenium.support.events.EventFiringDecorator;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.FluentWait;
import org.openqa.selenium.support.ui.Select;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;


import com.shop.Coupang;
import com.shop.CoupangAttributes;
import com.shop.CoupangContents;
import com.shop.CoupangDetails;
import com.shop.CoupangImages;
import com.shop.CoupangItems;
import com.shop.common.HmacOutboundShippingCreation;
import com.shop.common.HmacProductCreation;
import com.shop.common.HmacProductDelete;
import com.shop.common.HmacProductDetail;
import com.shop.common.HmacProductUpdate;
import com.shop.common.HmacReturnShippingCreation;
import com.shop.dto.CoupangAttributesDto;
import com.shop.dto.CoupangContentsDto;
import com.shop.dto.CoupangDetailsDto;
import com.shop.dto.CoupangDto;
import com.shop.dto.CoupangImagesDto;
import com.shop.dto.CoupangItemsDto;
import com.shop.dto.CoupangOutBoundDto;
import com.shop.dto.CoupangRequestDto;
import com.shop.dto.CoupangReturnDto;
import com.shop.entity.CoupangAttributesRepository;
import com.shop.entity.CoupangContentsRepository;
import com.shop.entity.CoupangDetailsRepository;
import com.shop.entity.CoupangImagesRepository;
import com.shop.entity.CoupangItemsRepository;
import com.shop.entity.CoupangRepository;
import com.shop.listener.CustomWebDriverListener;
import com.shop.selenium.costco.dto.SCoupangAuthentication;
import com.shop.selenium.costco.dto.SCoupangDto;
import com.shop.selenium.costco.dto.SCoupangLoginDto;
import com.shop.selenium.costco.dto.SCoupangPageDto;
import com.shop.selenium.costco.dto.SCoupangStockSearchDto;
import com.shop.selenium.util.ExtensionUtils;
import com.shop.selenium.util.ImageUtils;
import com.shop.selenium.util.JsonUtil;
import com.shop.selenium.util.ProductUtils;

import lombok.RequiredArgsConstructor;

@Transactional
@Service
@RequiredArgsConstructor
public class CoupangService {

	private static final String CURRENT_URL = "https://qudtn0295.cafe24.com/web/product/big/thmb102/";

	
//	private final CoupangJdbcRepository coupangJdbcRepository;
	private final CoupangItemsRepository coupangItemsRepository;
	
	private final CoupangRepository coupangRepository;
	private final CoupangImagesRepository coupangImagesRepository;
	private final CoupangAttributesRepository coupangAttributesRepository;
	private final CoupangDetailsRepository coupangDetailsRepository;
	private final CoupangContentsRepository coupangContentsRepository;

	private final HmacProductCreation hmacProductCreation;
	private final HmacOutboundShippingCreation hmacOutboundShippingCreation;
	private final HmacReturnShippingCreation hmacReturnShippingCreation;
	private final HmacProductDelete hmaProductDelete;
	private final HmacProductDetail hmacProductDetail;
	private final HmacProductUpdate hmacProductUpdate;
	
	@Value("${file.thmb-dir}")
	private String thmbDir;

	@Value("${file.detail-dir}")
	private String detailDir;

	@Transactional(readOnly = true)
	public Page<CoupangDto> getCoupangDto(Pageable pageable, int id, String searchKeyword) {

	    pageable = PageRequest.of(pageable.getPageNumber() > 0 ? pageable.getPageNumber() - 1 : 0, 10);

	    Page<Coupang> coupangPage;
	    if (searchKeyword != null && !searchKeyword.isEmpty()) {
	        coupangPage = coupangRepository.findByDisplayProductName(searchKeyword, pageable);  
	    } else {
	        coupangPage = coupangRepository.findAllDesc(pageable);  
	    }

	    List<CoupangDto> dtoList = coupangPage.getContent().stream().map(coupang -> {
	        List<CoupangItems> coupangItems = coupangItemsRepository.findItemsWithOptionalUserStatus(coupang.getCoupangId(), id, PageRequest.of(0, 200));
	        return CoupangDto.fromEntity(coupang, coupangItems);
	    }).collect(Collectors.toList());


	    return new PageImpl<>(dtoList, pageable, coupangPage.getTotalElements());
	}

	@Transactional(readOnly = true)
	public Page<CoupangDto> getDelCoupangDto(Pageable pageable, int id,String searchKeyword) {
		pageable = PageRequest.of(pageable.getPageNumber() > 0 ? pageable.getPageNumber() - 1 : 0, 10);

		
		Page<Coupang> coupangPage;
	    if (searchKeyword != null && !searchKeyword.isEmpty()) {
	        coupangPage = coupangRepository.findByDisplayProductName(searchKeyword, pageable);  
	    } else {
	        coupangPage =  coupangRepository.findAllDescDelete(pageable);
	    }
		
	    List<CoupangDto> dtoList = coupangPage.getContent().stream().map(coupang -> {
	        List<CoupangItems> coupangItems = coupangItemsRepository.findItemsWithOptionalUserStatusDelete(coupang.getCoupangId(), id, PageRequest.of(0, 200));
	        return CoupangDto.fromEntity(coupang, coupangItems);
	    }).collect(Collectors.toList());

		return new PageImpl<>(dtoList, pageable, coupangPage.getTotalElements());
	}
	
	public void loginUrl(String username, String password, String url, int startPage, int endPage)
			throws InterruptedException, NoSuchElementException, IOException {

	    EdgeOptions options = new EdgeOptions();
	    options.addArguments("--start-maximized"); // 브라우저 창 최대화

	    WebDriver baseDriver = new EdgeDriver(options);

	    CustomWebDriverListener eventListener = new CustomWebDriverListener(baseDriver);
	    EventFiringDecorator<WebDriver> decorator = new EventFiringDecorator<>(eventListener);
	    WebDriver driver = decorator.decorate(baseDriver);

	    // 로그인 실행
//	    SCoupangLoginDto login = new SCoupangLoginDto(driver);
//
//	    login.click(username, password, url);
//
//	    Thread.sleep(3000);
	    driver.get(url);
	    // 상품 페이지 이동
	    productPage(driver, username, password, url, startPage, endPage, eventListener);

	    // 브라우저 종료
	    driver.quit();

	}

	private void productPage(WebDriver driver,String username,String password ,String companyUrl, int startPage
			, int endPage,CustomWebDriverListener eventListener)
			throws InterruptedException, IOException {
		SCoupangPageDto page = new SCoupangPageDto(driver);
		List<String> urls = page.productNextPage(startPage, endPage);
		System.out.println(urls.size());
		for (String url : urls) {
			String apiKey="3c0da2a1b5014f290b3fbdd97f472c52";
			String proxyUrl = "http://api.scraperapi.com?api_key=" + apiKey + "&url=" + url;
			
			URL requestUrl = new URL(proxyUrl);
            HttpURLConnection conn = (HttpURLConnection) requestUrl.openConnection();
            conn.setRequestMethod("GET");
             
            BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
            StringBuilder content = new StringBuilder();
            String inputLine;
            while ((inputLine = in.readLine()) != null) {
                content.append(inputLine);
            }

            in.close();
            conn.disconnect();
			driver.navigate().to(url);
			
			SCoupangDto dto = new SCoupangDto(driver);
			FluentWait<WebDriver> wait = dto.getFluentWait(20);
			 
			dto.getPriceText(driver);
			dto.getCodeText(driver);
			dto.getTitleText(driver);

			String pageSource = driver.getPageSource();
			Document doc = Jsoup.parse(pageSource);
			
			Element productDetails = doc.selectFirst("body > main > div.page-content.container.main-wrapper > sip-product-details-page > sip-product-details");
			
			Element titleElement = productDetails.selectFirst("div > sip-product-title > div > h1");
			Element codeElement = productDetails.selectFirst("div > sip-product-title > div > p > span.notranslate");
			Element priceElement = productDetails.selectFirst(
			    "div.price-after-discount > div > span, " +
			    "div.price-original > span > sip-format-price > span"
			);
			
			String title = titleElement != null ? titleElement.text() : null;
	        String code = codeElement != null ? codeElement.text() : null;
	    	String price = (priceElement != null) ? priceElement.text() : null;
			System.out.println(title);
			System.out.println(code);
			System.out.println(price);
	        Integer existCode = coupangRepository.existsByProductCode(code, title);
	        System.out.println();
			if (existCode == null || existCode == 0) {
				StringBuilder sbDetailFileName = new StringBuilder();
				int convertedPrice = (price != null) ? ProductUtils.productPriceConverter(price) : 0;
				
				//썸네일 모두 클릭
				dto.getImageSubListsClick();
				//썸네일
				String thmbUrl = dto.getThmbImageUrls(new StringBuilder(),doc,thmbDir);

				//서브 썸네일
				String thmbSubUrl = dto.getThumbSubImageUrls(new StringBuilder(),doc,thmbDir);

				JavascriptExecutor js = (JavascriptExecutor) driver;
				js.executeScript("window.scrollBy(0, 500);");	
				
				// 상세버튼 누르기
				dto.clickDetailButtonIfExists();
				String detailsTexts = dto.getDetailTexts(new StringBuilder());
				
				String detailUrl = dto.getDetailImageUrls(new StringBuilder(),doc,detailDir);

				//정렬
				sbDetailFileName.append("<p align='center'>");
				
				//제품 정보
				sbDetailFileName.append(detailsTexts);
				//상세 이미지 정보
				sbDetailFileName.append(thmbSubUrl);
				sbDetailFileName.append(detailUrl);
				//배송정보
				String dvInformation=dto.getDeliveryInformation(new StringBuilder());
				sbDetailFileName.append(dvInformation);
				//고시 정보 버튼 존재 하는지 확인 있으면 클릭
				dto.clickNotificationButtonIfExists();
				
				String ntInformation = dto.getNotificationInformation(new StringBuilder(),wait);
				//고시정보
				sbDetailFileName.append(ntInformation);
				
				sbDetailFileName.append("</p>");
				
				// 셀렉트박스 개수
				StringBuilder selectBoxEnabled = new StringBuilder();
				int size = dto.getSelectBox().size();
				String repeatedString = "F|".repeat(size);
				selectBoxEnabled.append(repeatedString);
				if (selectBoxEnabled.toString().equals("F|") || selectBoxEnabled.toString().equals("F|F|")
						|| selectBoxEnabled.toString().equals("F|F|F|")) {
					
					CoupangDto coupangDto = CoupangDto.builder()
						    .sellerProductName(title)
						    .vendorId("A00962060")
						    .displayProductName(title)
						    .saleStartedAt("2024-01-19T00:00:00")
						    .saleEndedAt("2099-01-19T00:00:00")
						    .deliveryMethod("SEQUENCIAL")
						    .deliveryCompanyCode("EPOST")
						    .deliveryChargeType("NOT_FREE")
						    .deliveryCharge(3000)
						    .freeShipOverAmount(30000)
						    .deliveryChargeOnReturn(3000)
						    .remoteAreaDeliverable("N")
						    .unionDeliveryType("NOT_UNION_DELIVERY")
						    .returnCenterCode("1001694769")
						    .returnChargeName("경기도 안산시 상록구 충장로 565 111동1203호")
						    .companyContactNumber("010-8900-6085")
						    .returnZipCode("15287")
						    .returnAddress("경기도 안산시 상록구 충장로 565")
						    .returnAddressDetail("111동1203호")
						    .returnCharge(3000)
						    .outboundShippingPlaceCode(19389011)
						    .vendorUserId("qudtn0295")
						    .requested(true)
						    .productCode(code)
						    .currentUrl(driver.getCurrentUrl())
						    .build();
					Coupang coupang = CoupangDto.toEntity(coupangDto);
					processOptions(driver,doc,dto.getSelectBox(), 0, "", coupang, convertedPrice, thmbUrl.toString(),
							sbDetailFileName.toString(), selectBoxEnabled.toString(), "", "", "",wait);

				} else if (selectBoxEnabled.toString().isEmpty() && dto.getRadioBox().size() == 0) {
					// 단일 상품
					List<CoupangAttributesDto> attributes = new ArrayList<>();
					List<CoupangItemsDto> items = new ArrayList<>();
					List<CoupangImagesDto> images = new ArrayList<>();
					List<CoupangContentsDto> contents = new ArrayList<>();
					List<CoupangDetailsDto> details = new ArrayList<>();

					CoupangDto coupangDto = CoupangDto.builder()
						    .sellerProductName(title)
						    .vendorId("A00962060")
						    .displayProductName(title)
						    .saleStartedAt("2024-01-19T00:00:00")
						    .saleEndedAt("2099-01-19T00:00:00")
						    .deliveryMethod("SEQUENCIAL")
						    .deliveryCompanyCode("EPOST")
						    .deliveryChargeType("NOT_FREE")
						    .deliveryCharge(3000)
						    .freeShipOverAmount(30000)
						    .deliveryChargeOnReturn(3000)
						    .remoteAreaDeliverable("N")
						    .unionDeliveryType("NOT_UNION_DELIVERY")
						    .returnCenterCode("1001694769")
						    .returnChargeName("경기도 안산시 상록구 충장로 565 111동1203호")
						    .companyContactNumber("010-8900-6085")
						    .returnZipCode("15287")
						    .returnAddress("경기도 안산시 상록구 충장로 565")
						    .returnAddressDetail("111동1203호")
						    .returnCharge(3000)
						    .outboundShippingPlaceCode(19389011)
						    .vendorUserId("qudtn0295")
						    .requested(true)
						    .productCode(code)
						    .currentUrl(driver.getCurrentUrl())
						    .build();

					
					String optionName = title;
					int productPrice = convertedPrice;
					String thmbnail = thmbUrl.toString();
					String detailImage = sbDetailFileName.toString();
					
					
					coupangSingleProudctSave(coupangDto, items, attributes, images, contents, details, optionName,
							productPrice, thmbnail, detailImage);
				} else if (dto.getRadioBox().size() > 0) {
					CoupangDto coupangDto = CoupangDto.builder()
						    .sellerProductName(title)
						    .vendorId("A00962060")
						    .displayProductName(title)
						    .saleStartedAt("2024-01-19T00:00:00")
						    .saleEndedAt("2099-01-19T00:00:00")
						    .deliveryMethod("SEQUENCIAL")
						    .deliveryCompanyCode("EPOST")
						    .deliveryChargeType("NOT_FREE")
						    .deliveryCharge(3000)
						    .freeShipOverAmount(30000)
						    .deliveryChargeOnReturn(3000)
						    .remoteAreaDeliverable("N")
						    .unionDeliveryType("NOT_UNION_DELIVERY")
						    .returnCenterCode("1001694769")
						    .returnChargeName("경기도 안산시 상록구 충장로 565 111동1203호")
						    .companyContactNumber("010-8900-6085")
						    .returnZipCode("15287")
						    .returnAddress("경기도 안산시 상록구 충장로 565")
						    .returnAddressDetail("111동1203호")
						    .returnCharge(3000)
						    .outboundShippingPlaceCode(19389011)
						    .vendorUserId("qudtn0295")
						    .requested(true)
						    .productCode(code)
						    .currentUrl(driver.getCurrentUrl())
						    .build();

//					processRadios(doc,driver,dto.getRadioBox(),dto.getSelectBox(), coupangDto, convertedPrice, thmbUrl.toString(),
//							sbDetailFileName.toString(),selectBoxEnabled.toString(),dto);
				}
			}
		}
	}

//	@Transactional
//	private void processRadios(Document doc,WebDriver driver, List<WebElement> radios, List<WebElement> selects, CoupangDto coupangDto, int price, String thmb, String detailImages, String selectBoxEnabled, SCoupangDto dto) throws InterruptedException {
//		WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));
//		List<CoupangAttributesDto> attributes = new ArrayList<>();
//		List<CoupangItemsDto> items = new ArrayList<>();
//		List<CoupangImagesDto> images = new ArrayList<>();
//		List<CoupangContentsDto> contents = new ArrayList<>();
//		List<CoupangDetailsDto> details = new ArrayList<>();
//
//		for (int i = 0; i < radios.size(); i++) {
//			WebElement radio = radios.get(i);
//            
//            try {
//            	WebElement clickableRadio = wait.until(ExpectedConditions.elementToBeClickable(radio));
//                clickableRadio.click(); 
//
//                wait.until(ExpectedConditions.stalenessOf(radio));
//
//            	radios = wait.until(
//	            		ExpectedConditions.presenceOfAllElementsLocatedBy(By.cssSelector("body > main > div.page-content.container.main-wrapper > sip-product-details-page > sip-product-details > div > div.header-content-container.col-xs-12.col-sm-12.col-md-6.col-tab-6.ng-star-inserted > div > div > div > div > sip-variant-selector > div > div > div > ul > li> a"))
//				);
//	            
//	            selects = wait.until(
//	            		ExpectedConditions.presenceOfAllElementsLocatedBy(By.cssSelector("#variant-selector"))
//				);
//            }catch (TimeoutException|NoSuchElementException e) {
//            	System.out.println(e);
//            }catch (StaleElementReferenceException e) {
//                radios = wait.until(
//                    ExpectedConditions.presenceOfAllElementsLocatedBy(By.cssSelector("body > main > div.page-content.container.main-wrapper > sip-product-details-page > sip-product-details > div > div.header-content-container.col-xs-12.col-sm-12.col-md-6.col-tab-6.ng-star-inserted > div > div > div > div > sip-variant-selector > div > div > div > ul > li> a"))
//                );
//
//                radio = radios.get(i);
//                radio.click();
//            }
//            
//
//            if(selects.size()==0) {
//            	WebElement radioText = wait.until(ExpectedConditions.presenceOfElementLocated(
//		                By.cssSelector("span.product-code.ng-star-inserted")
//		        ));
//	
//            	CoupangItemsDto coupangItems = CoupangItemsDto.builder()
//            		    .coupangDto(coupangDto)
//            		    .itemName(radioText.getText())
//            		    .maximumBuyCount(10)
//            		    .maximumBuyForPerson(0)
//            		    .maximumBuyForPersonPeriod(1)
//            		    .outboundShippingTimeDay(3)
//            		    .unitCount(0)
//            		    .adultOnly("EVERYONE")
//            		    .taxType("TAX")
//            		    .parallelImported("NOT_PARALLEL_IMPORTED")
//            		    .overseasPurchased("NOT_OVERSEAS_PURCHASED")
//            		    .pccNeeded(false)
//            		    .originalPrice(price)
//            		    .salePrice(price)
//            		    .build();
//
//        		items.add(coupangItems);
//
//        		CoupangImagesDto coupangImages = CoupangImagesDto.builder()
//    				.coupangDto(coupangDto)
//        		    .imageOrder(0)
//        		    .imageType("REPRESENTATION")
//        		    .vendorPath(CURRENT_URL + thmb)
//        		    .coupangItemsDto(coupangItems)
//        		    .build();
//
//        		images.add(coupangImages);
//
//        		CoupangContentsDto coupangContents = CoupangContentsDto.builder()
//    				.coupangDto(coupangDto)
//        		    .contentsType("TEXT")
//        		    .coupangItemsDto(coupangItems)
//        		    .build();
//
//        		contents.add(coupangContents);
//
//        		CoupangDetailsDto coupangDetails = CoupangDetailsDto.builder()
//    				.coupangDto(coupangDto)
//        		    .content(detailImages)
//        		    .detailType("TEXT")
//        		    .coupangContentsDto(coupangContents)
//        		    .build();
//
//        		details.add(coupangDetails);
//
//        		if (radios.size() > 0) {
//        		    CoupangAttributesDto coupangAttributes = CoupangAttributesDto.builder()
//    		    		.coupangDto(coupangDto)
//        		        .attributeTypeName("옵션")
//        		        .attributeValueName(radioText.getText())
//        		        .coupangItemsDto(coupangItems)
//        		        .build();
//
//        		    attributes.add(coupangAttributes);
//        		}
//
//            }else {
//            	
//            	StringBuilder sbe = new StringBuilder();
//				int size = dto.getSelectBox().size();
//				String repeatedString = "F|".repeat(size);
//				sbe.append(repeatedString);
//
//				processOptions(driver,doc,selects, 0, "", coupang, price,thmb ,
//			            detailImages, sbe.toString(), "", "", "",wait);
//            }
//		}
//
//	}
	
	public void processOptions(WebDriver driver, Document doc, List<WebElement> allSelects, int index, String combinedOption, Coupang coupang, int price,
            String thmb, String detailImages, String selectBox, String firstOption,
            String secondOption, String thirdOption, FluentWait<WebDriver> wait) throws InterruptedException {

		if (index >= allSelects.size()) {
			handleResults(coupang, combinedOption, price, thmb, detailImages, selectBox, firstOption, secondOption, thirdOption);
			return;
		}

		WebElement currentSelectElement = allSelects.get(index);
		Select select;

		try {
			select = new Select(currentSelectElement);
			select.selectByIndex(1);
		} catch (NoSuchElementException e) {
			select = new Select(currentSelectElement);
			select.selectByIndex(0);
		} catch (StaleElementReferenceException e) {
			allSelects = wait.until(ExpectedConditions.presenceOfAllElementsLocatedBy(By.cssSelector("#variant-selector")));
			currentSelectElement = allSelects.get(index);
			select = new Select(currentSelectElement);
			select.selectByIndex(0);
		}
        wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector("#variant-selector option")));

        String pageSource = driver.getPageSource();
        doc = Jsoup.parse(pageSource);
        
        try {
            Elements options = doc.select("#variant-selector option");
			for (Element option : options) {
			String optionValue = option.text().trim();
			if (!optionValue.isEmpty() && !optionValue.equals("-------------------") && !optionValue.equals("선택 size") &&
				!optionValue.equals("선택 옵션") && !optionValue.equals("선택 사이즈")) {
				
				String newCombinedOption = combinedOption.isEmpty() ? optionValue : combinedOption + " " + optionValue;
				if (index == 0) {
				    processOptions(driver,doc,allSelects, index + 1, newCombinedOption, coupang, price, thmb,
				                    detailImages, selectBox, optionValue, secondOption, thirdOption, wait);
				} else if (index == 1) {
				    processOptions(driver,doc,allSelects, index + 1, newCombinedOption, coupang, price, thmb,
				                    detailImages, selectBox, firstOption, optionValue, thirdOption, wait);
				} else if (index == 2) {
				    processOptions(driver,doc,allSelects, index + 1, newCombinedOption, coupang, price, thmb,
				                    detailImages, selectBox, firstOption, secondOption, optionValue, wait);
				}
			}
			}
		} catch (NoSuchElementException | StaleElementReferenceException e) {
			System.out.println("Error processing options: " + e.getMessage());
		}
	}

	private void handleResults(Coupang coupang, String combinedOption, int price, String thmb, String detailImages,
            String selectBox, String firstOption, String secondOption, String thirdOption) {
			List<CoupangItems> items = new ArrayList<>();
			List<CoupangImages> images = new ArrayList<>();
			List<CoupangContents> contents = new ArrayList<>();
			List<CoupangDetails> details = new ArrayList<>();
			List<CoupangAttributes> attributes = new ArrayList<>();
			
			if (selectBox.equals("F|") || selectBox.equals("F|F|") || selectBox.equals("F|F|F|")) {
			// ✅ CoupangItems 생성 (Coupang을 직접 FK로 설정)
			items = coupang.getItems().stream()
			.map(dto -> CoupangItems.builder()
			 .itemId(dto.getItemId())
			 .coupang(coupang) // ✅ FK 설정
			 .itemName(dto.getItemName())
			 .originalPrice(dto.getOriginalPrice())
			 .salePrice(dto.getSalePrice())
			 .build())
			.collect(Collectors.toList());
			
			// ✅ CoupangImages 생성 (CoupangItems FK 연결)
			images = items.stream()
			.map(item -> CoupangImages.builder()
			 .imageOrder(0)
			 .imageType("REPRESENTATION")
			 .vendorPath(thmb)
			 .coupangItems(item) // ✅ FK 설정
			 .coupang(coupang)
			 .build())
			.collect(Collectors.toList());
			
			// ✅ CoupangContents 생성
			contents = items.stream()
			.map(item -> CoupangContents.builder()
			 .contentsType("TEXT")
			 .coupangItems(item) // ✅ FK 설정
			 .coupang(coupang)
			 .build())
			.collect(Collectors.toList());
			
			// ✅ CoupangDetails 생성 (CoupangContents FK 연결)
			details = contents.stream()
			.map(content -> CoupangDetails.builder()
			 .coupang(coupang)
			 .content(detailImages)
			 .detailType("TEXT")
			 .coupangContents(content) // ✅ FK 설정
			 .build())
			.collect(Collectors.toList());
			
			// ✅ CoupangAttributes 생성 (CoupangItems FK 연결)
			attributes = items.stream()
			.flatMap(item -> {
			 List<CoupangAttributes> attrList = new ArrayList<>();
			 if (selectBox.equals("F|")) {
			     attrList.add(CoupangAttributes.builder()
			         .coupang(coupang)
			         .attributeTypeName("옵션")
			         .attributeValueName(firstOption)
			         .coupangItems(item) // ✅ FK 설정
			         .build());
			 } else if (selectBox.equals("F|F|") && !combinedOption.isEmpty()) {
			     attrList.add(CoupangAttributes.builder()
			         .coupang(coupang)
			         .attributeTypeName("옵션")
			         .attributeValueName(secondOption)
			         .coupangItems(item)
			         .build());
			
			     attrList.add(CoupangAttributes.builder()
			         .coupang(coupang)
			         .attributeTypeName("옵션2")
			         .attributeValueName(firstOption)
			         .coupangItems(item)
			         .build());
			 }
			 return attrList.stream();
			})
			.collect(Collectors.toList());
			}
			
			// ✅ Coupang을 직접 전달하여 저장
			CoupangProductSave(coupang, items, images, attributes, details, contents);
	}


	@Transactional
	private void CoupangProductSave(Coupang coupang,List<CoupangItems> items, List<CoupangImages> images,
			List<CoupangAttributes> attributes, List<CoupangDetails> details, List<CoupangContents> contents) {
		 	if (items.isEmpty()) return; 

		 	final Coupang savedCoupang = coupangRepository.save(coupang);
		 	System.out.println("===============================");
		 	System.out.println(savedCoupang.getCurrentUrl());
		 	System.out.println("===============================");
		 	coupangItemsRepository.saveAll(items);
		 	coupangImagesRepository.saveAll(images);
		 	coupangContentsRepository.saveAll(contents);
		 	coupangDetailsRepository.saveAll(details);
		 	coupangAttributesRepository.saveAll(attributes);
	}

	@Transactional
	private void coupangSingleProudctSave(CoupangDto coupangDto, List<CoupangItemsDto> items, List<CoupangAttributesDto> attributes, List<CoupangImagesDto> images, List<CoupangContentsDto> contents, List<CoupangDetailsDto> details, String optionName, int productPrice, String thmbnail, String detailImage) {

//		CoupangItemsDto coupangItems = CoupangItemsDto.builder()
//			    .itemName(optionName)
//			    .maximumBuyCount(10)
//			    .maximumBuyForPerson(0)
//			    .maximumBuyForPersonPeriod(1)
//			    .outboundShippingTimeDay(3)
//			    .unitCount(0)
//			    .adultOnly("EVERYONE")
//			    .taxType("TAX")
//			    .parallelImported("NOT_PARALLEL_IMPORTED")
//			    .overseasPurchased("NOT_OVERSEAS_PURCHASED")
//			    .pccNeeded(false)
//			    .originalPrice(productPrice)
//			    .salePrice(productPrice)
//			    .coupangDto(coupangDto)
//			    .build();
//		items.add(coupangItems);
//		
//		for (CoupangItemsDto itemId : items) {
//		    CoupangImagesDto coupangImages = CoupangImagesDto.builder()
//		            .imageOrder(0)
//		            .imageType("REPRESENTATION")
//		            .vendorPath(CURRENT_URL + thmbnail)
//		            .coupangItemsDto(CoupangItemsDto.builder()
//		                    .id(itemId.getId())
//		                    .itemName(itemId.getItemName())
//		                    .build())
//		            .coupangDto(CoupangDto.builder()
//		                    .coupangId(coupangDto.getCoupangId())
//		                    .build())
//		            .build();
//		    images.add(coupangImages);
//
//		    CoupangContentsDto coupangContents = CoupangContentsDto.builder()
//		            .contentsType("TEXT")
//		            .coupangItemsDto(CoupangItemsDto.builder()
//		                    .id(itemId.getId())
//		                    .itemName(itemId.getItemName())
//		                    .build())
//		            .coupangDto(CoupangDto.builder()
//		                    .coupangId(coupangDto.getCoupangId())
//		                    .build())
//		            .build();
//		    contents.add(coupangContents);
//		}
//
//		for (CoupangContentsDto content : contents) {
//			CoupangDetailsDto coupangDetails = CoupangDetailsDto.builder()
//				    .content(detailImage)
//				    .detailType("TEXT")
//				    .coupangContentsDto(CoupangContentsDto.builder()
//				        .build())
//				    .coupangDto(CoupangDto.builder()
//				        .coupangId(content.getCoupangDto().getCoupangId())
//				        .build())
//				    .build();
//
//		    details.add(coupangDetails);
//		}
//		CoupangProductSave(coupangDto,items,images,contents,details);
	}


	@Transactional
	public List<CoupangDto> selectedListCoupang(CoupangRequestDto selectedCoupangProducts) throws URISyntaxException {
	    List<CoupangDto> dtoList = new ArrayList<>();
	    Pageable itemLimit = PageRequest.of(0, 200);

	    List<String> tagsList = Arrays.asList(selectedCoupangProducts.getSearchTags().split(","));

	    List<Long> coupangItemsId = new ArrayList<>();
	    for (Long selected : selectedCoupangProducts.getSelectedCoupangProducts()) {
	        Coupang coupang = coupangRepository.findById(selected)
	                .orElseThrow(() -> new IllegalArgumentException("쿠팡 번호가 없음=" + selected));
	        URI uri = new URI(coupang.getCurrentUrl());
	        String host = uri.getHost();
	        String brand = "";
	        if (host.equals("trycozy.com")) {
	            brand = ProductUtils.replaceBracketsWithConverter(coupang.getDisplayProductName(),
	                    selectedCoupangProducts.getBrand());
	        } else if (host.equals("carssenb2b.com")) {
	            brand = ProductUtils.replaceBracketsCarssenWithConverter(coupang.getDisplayProductName(),
	                    selectedCoupangProducts.getBrand());
	        } else if(host.equals("www.costco.co.kr")) {
	            brand = ProductUtils.replaceBracketsCostcoWithConverter(coupang.getDisplayProductName(),
	                    selectedCoupangProducts.getBrand());
	        }

	        List<CoupangItems> coupangItems = Collections.emptyList();
	        if (coupang.getItems() != null && !coupang.getItems().isEmpty()) {
	            coupangItems = coupangItemsRepository.findItemsWithOptionalUserStatus(coupang.getCoupangId(),
	                    selectedCoupangProducts.getId(), itemLimit);
	            for (CoupangItems item : coupangItems) {
	                coupangItemsId.add(item.getItemId());
	            }
	        }

	        dtoList.add(CoupangDto.builder()
	            .coupangId(coupang.getCoupangId())
	            .sellerProductName(coupang.getSellerProductName())
	            .vendorId(coupang.getVendorId())
	            .saleStartedAt(coupang.getSaleStartedAt())
	            .saleEndedAt(coupang.getSaleEndedAt())
	            .displayProductName(coupang.getDisplayProductName())
	            .deliveryMethod(coupang.getDeliveryMethod())
	            .deliveryCompanyCode(coupang.getDeliveryCompanyCode())
	            .deliveryChargeType(coupang.getDeliveryChargeType())
	            .deliveryCharge(coupang.getDeliveryCharge())
	            .freeShipOverAmount(coupang.getFreeShipOverAmount())
	            .deliveryChargeOnReturn(coupang.getDeliveryChargeOnReturn())
	            .remoteAreaDeliverable(coupang.getRemoteAreaDeliverable())
	            .unionDeliveryType(coupang.getUnionDeliveryType())
	            .returnCenterCode(coupang.getReturnCenterCode())
	            .returnChargeName(coupang.getReturnChargeName())
	            .companyContactNumber(coupang.getCompanyContactNumber())
	            .returnZipCode(coupang.getReturnZipCode())
	            .returnAddress(coupang.getReturnAddress())
	            .returnAddressDetail(coupang.getReturnAddressDetail())
	            .returnCharge(coupang.getReturnCharge())
	            .outboundShippingPlaceCode(coupang.getOutboundShippingPlaceCode())
	            .vendorUserId(coupang.getVendorUserId())
	            .requested(coupang.getRequested())
	            .productCode(coupang.getProductCode())
	            .currentUrl(coupang.getCurrentUrl())
	            .manufacture(coupang.getManufacture())
	            .productSellerId(coupang.getSellerProductId())
	            .items(coupangItems.stream().map(CoupangItemsDto::fromEntity).collect(Collectors.toList()))
	            .build());
	    }

	    for (CoupangDto dto : dtoList) {
	        if (dto.getItems() != null && !dto.getItems().isEmpty()) {
	            String json = JsonUtil.convertListToJson(dto);
	            hmacProductCreation.sendDataToCoupang(json, dto.getCoupangId(), coupangItemsId, selectedCoupangProducts.getId());
	            try {
	                TimeUnit.SECONDS.sleep(3);
	            } catch (InterruptedException e) {
	                Thread.currentThread().interrupt();
	            }
	        }
	    }

	    return dtoList;
	}

	public void outboundShipping(CoupangOutBoundDto coupangOutBoundRequest) {
		String json = JsonUtil.convertListToJson(coupangOutBoundRequest);
		hmacOutboundShippingCreation.sendDataToCoupang(json);
	}

	public void returnShipping(CoupangReturnDto coupangReturnDto) {
		String json = JsonUtil.convertListToJson(coupangReturnDto);
		hmacReturnShippingCreation.sendDataToCoupang(json);
	}

	@Transactional(readOnly = true)
	public CoupangDto getCoupangDetail(Long coupangId, int userId) {
	    Coupang coupang = coupangRepository.findById(coupangId)
	            .orElseThrow(() -> new IllegalArgumentException("coupangId not found"));

	    List<CoupangItems> coupangItems = coupangItemsRepository.findItemsWithOptionalUserStatus(coupang.getCoupangId(), userId, PageRequest.of(0, 200));

	    return CoupangDto.builder()
	            .coupangId(coupang.getCoupangId())
	            .sellerProductName(coupang.getSellerProductName())
	            .vendorId(coupang.getVendorId())
	            .saleStartedAt(coupang.getSaleStartedAt())
	            .saleEndedAt(coupang.getSaleEndedAt())
	            .displayProductName(coupang.getDisplayProductName())
	            .deliveryMethod(coupang.getDeliveryMethod())
	            .deliveryCompanyCode(coupang.getDeliveryCompanyCode())
	            .deliveryChargeType(coupang.getDeliveryChargeType())
	            .deliveryCharge(coupang.getDeliveryCharge())
	            .freeShipOverAmount(coupang.getFreeShipOverAmount())
	            .deliveryChargeOnReturn(coupang.getDeliveryChargeOnReturn())
	            .remoteAreaDeliverable(coupang.getRemoteAreaDeliverable())
	            .unionDeliveryType(coupang.getUnionDeliveryType())
	            .returnCenterCode(coupang.getReturnCenterCode())
	            .returnChargeName(coupang.getReturnChargeName())
	            .companyContactNumber(coupang.getCompanyContactNumber())
	            .returnZipCode(coupang.getReturnZipCode())
	            .returnAddress(coupang.getReturnAddress())
	            .returnAddressDetail(coupang.getReturnAddressDetail())
	            .returnCharge(coupang.getReturnCharge())
	            .outboundShippingPlaceCode(coupang.getOutboundShippingPlaceCode())
	            .vendorUserId(coupang.getVendorUserId())
	            .requested(coupang.getRequested())
	            .productCode(coupang.getProductCode())
	            .currentUrl(coupang.getCurrentUrl())
	            .manufacture(coupang.getManufacture())
	            .productSellerId(coupang.getSellerProductId())
	            .items(coupangItems.stream().map(CoupangItemsDto::fromEntity).collect(Collectors.toList()))
	            .build();
	}

	@Transactional
	public void deleteCoupang(long id, long productSellerId) throws InterruptedException {
	    List<Long> productItemsId = hmacProductDetail.detailDataToCoupang(productSellerId);
		for(Long itemId:productItemsId) {
			hmacProductUpdate.updateDataToCoupang(itemId);
		}
		hmaProductDelete.deleteDataToCoupang(productSellerId);
	    coupangRepository.deleteById(id);
	}
	
	@Transactional
	public void stockCoupangDelete(String email) throws InterruptedException, IOException {

		EdgeOptions options = new EdgeOptions();
	    options.addArguments("--start-maximized"); // 브라우저 창 최대화

	    WebDriver baseDriver = new EdgeDriver(options);

	    // CustomWebDriverListener 인스턴스 생성 및 EventFiringDecorator로 감싸기
	    CustomWebDriverListener eventListener = new CustomWebDriverListener(baseDriver);
	    EventFiringDecorator<WebDriver> decorator = new EventFiringDecorator<>(eventListener);
	    WebDriver driver = decorator.decorate(baseDriver);

		driver.get("https://www.costco.co.kr/");
		FluentWait<WebDriver> wait = new FluentWait<>(driver)
                .withTimeout(Duration.ofSeconds(20)) // 최대 20초 기다림
                .pollingEvery(Duration.ofMillis(500)) // 0.5초마다 체크
                .ignoring(NoSuchElementException.class); // 요소가 없을 때 예외 무시

		SCoupangLoginDto login = new SCoupangLoginDto(driver);
		SCoupangStockSearchDto stockSearchDto = new SCoupangStockSearchDto(driver);
		SCoupangDto searchCoupang = new SCoupangDto(driver);
		login.deleteClick(email, "qudtn!4589");
	    List<Coupang> coupangs = coupangRepository.findAll();
	    List<String> stockSoldOut = stockSearchDto.search(coupangs);
	    StringBuilder selectBoxEnabled = new StringBuilder();
		int size = searchCoupang.getSelectBox().size();
		String repeatedString = "F|".repeat(size);
		selectBoxEnabled.append(repeatedString);
	    for (Coupang coupang : coupangs) {
	        if (stockSoldOut.contains(coupang.getProductCode())) {
	        	System.out.println(coupang.getProductCode());
	        	System.out.println(coupang.getCurrentUrl());
	        	System.out.println(coupang.getDisplayProductName());
	        	processDeleteOptions(searchCoupang.getSelectBox(),0,driver,selectBoxEnabled.toString(),wait);
//	            List<Long> productItemsId = hmacProductDetail.detailDataToCoupang(coupang.getSellerProductId());
//	            for (Long itemId : productItemsId) {
//	            	try {
//	            		hmacProductUpdate.updateDataToCoupang(itemId);
//	            	}catch (Exception e) {
//	            		  e.printStackTrace();
//	            	}
//            	}
//	            hmaProductDelete.deleteDataToCoupang(coupang.getSellerProductId());
//	            coupangRepository.deleteById(coupang.getCoupangId());
	        }
	    }
	    driver.quit();
	}

	@Transactional
	public void deleteOneCoupang(Long id) {
		coupangRepository.deleteById(id);
	}
	
	private String url="https://www.costco.co.kr/";
	private void processDeleteOptions(List<WebElement> allSelects, int index, WebDriver driver, String selectBox, FluentWait<WebDriver> wait) throws InterruptedException, IOException {
	    if (index >= allSelects.size()) {
	        return;  // 모든 옵션을 처리하면 종료
	    }

	    WebElement currentSelectElement = allSelects.get(index);
	    Select select = new Select(currentSelectElement);

	    try {
	        List<WebElement> options = select.getOptions(); // 현재 select 박스의 옵션들 가져오기

	        for (int i = 0; i < options.size(); i++) {
	            WebElement option = options.get(i);

	            String optionValue = option.getText().trim();
	            if (!optionValue.isEmpty() && !optionValue.equals("-------------------") && 
	                !optionValue.equals("선택 size") && !optionValue.equals("선택 옵션") && 
	                !optionValue.equals("선택 사이즈")) {
	            	

	                // 옵션 선택
	                select.selectByIndex(i);
	                String value = option.getAttribute("value");
	                String apiKey="3c0da2a1b5014f290b3fbdd97f472c52";
	    			String proxyUrl = "http://api.scraperapi.com?api_key=" + apiKey + "&url=" + url;
	    			
	    			URL requestUrl = new URL(proxyUrl);
	                HttpURLConnection conn = (HttpURLConnection) requestUrl.openConnection();
	                conn.setRequestMethod("GET");
	                 
	                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
	                StringBuilder content = new StringBuilder();
	                String inputLine;
	                while ((inputLine = in.readLine()) != null) {
	                    content.append(inputLine);
	                }

	                in.close();
	                conn.disconnect();
	                System.out.println("Selected: " + optionValue);

	                // 다음 select 박스로 이동
	                processDeleteOptions(wait.until(ExpectedConditions.presenceOfAllElementsLocatedBy(By.cssSelector("#variant-selector"))), index + 1, driver, selectBox, wait);
	            }
	        }
	    } catch (StaleElementReferenceException e) {
	        System.out.println("Element became stale: " + e.getMessage());

	        allSelects = wait.until(ExpectedConditions.presenceOfAllElementsLocatedBy(By.cssSelector("#variant-selector")));
	        processDeleteOptions(allSelects, index, driver, selectBox, wait);
	    }
	}
	
}
