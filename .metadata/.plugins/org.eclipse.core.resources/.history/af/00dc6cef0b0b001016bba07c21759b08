package com.coupang.hamc;

import org.apache.http.HttpEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import org.json.JSONObject;

import com.coupang.openapi.sdk.Hmac;

import java.net.URI;
import org.apache.http.client.utils.URIBuilder;

public class HmacProudctQuantityUpdate {
	private static final String HOST = "api-gateway.coupang.com";
    private static final int PORT = 443;
    private static final String SCHEMA = "https";
    private static final String ACCESS_KEY = "f20949fb-c3f6-417a-a357-94d4e6f405d6";
    private static final String SECRET_KEY = "0d4263d854b749ba1742a44d8223c7bf6854d5cc";
    
    /**
     * ì¿ íŒ¡ APIë¥¼ í†µí•´ íŠ¹ì • ì˜µì…˜(vendorItemId)ì˜ ì¬ê³  ìˆ˜ëŸ‰(quantity) ì—…ë°ì´íŠ¸
     */
    public void updateCoupangStock(Long vendorItemId, int quantity) {
        String method = "PUT";
        String path = "/v2/providers/seller_api/apis/api/v1/marketplace/vendor-items/" + vendorItemId + "/quantities/" + quantity;

        try (CloseableHttpClient client = HttpClients.createDefault()) {
            // ğŸ”¹ URI ì„¤ì •
            URI uri = new URIBuilder()
                    .setScheme(SCHEMA)
                    .setHost(HOST)
                    .setPort(PORT)
                    .setPath(path)
                    .build();

            URIBuilder uriBuilder = new URIBuilder().setPath(path);

            // ğŸ”¹ HMAC ì¸ì¦ í† í° ìƒì„±
            String authorization = Hmac.generate(method, uriBuilder.build().toString(), SECRET_KEY, ACCESS_KEY);

            // ğŸ”¹ HTTP PUT ìš”ì²­ ìƒì„±
            HttpPut requestPut = new HttpPut(uri);
            requestPut.addHeader("Authorization", authorization);
            requestPut.addHeader("Content-Type", "application/json");

            // ğŸ”¹ API ìš”ì²­ ì‹¤í–‰
            try (CloseableHttpResponse response = client.execute(requestPut)) {
                System.out.println("ğŸ”¹ HTTP ìƒíƒœ ì½”ë“œ: " + response.getStatusLine().getStatusCode());
                System.out.println("ğŸ”¹ ìƒíƒœ ë©”ì‹œì§€: " + response.getStatusLine().getReasonPhrase());

                HttpEntity entity = response.getEntity();
                String responseBody = EntityUtils.toString(entity);
                System.out.println("ğŸ”¹ ì‘ë‹µ ê²°ê³¼: " + responseBody);

                // ğŸ”¹ JSON ì‘ë‹µ íŒŒì‹±
                JSONObject jsonObj = new JSONObject(responseBody);
                if (jsonObj.has("code") && "SUCCESS".equals(jsonObj.getString("code"))) {
                    System.out.println("âœ… ì¬ê³  ì—…ë°ì´íŠ¸ ì„±ê³µ! ì˜µì…˜ ID: " + vendorItemId + ", ë³€ê²½ëœ ìˆ˜ëŸ‰: " + quantity);
                } else {
                    System.out.println("âŒ ì¬ê³  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨! ì˜¤ë¥˜ ë©”ì‹œì§€: " + jsonObj.getString("message"));
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}


