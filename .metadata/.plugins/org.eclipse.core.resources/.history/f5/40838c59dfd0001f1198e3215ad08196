package com.shop.service;

import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URI;
import java.net.URISyntaxException;
import java.time.Duration;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.StaleElementReferenceException;
import org.openqa.selenium.TimeoutException;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.edge.EdgeDriver;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.Select;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;


import com.shop.Coupang;
import com.shop.CoupangAttributes;
import com.shop.CoupangContents;
import com.shop.CoupangDetails;
import com.shop.CoupangImages;
import com.shop.CoupangItems;
import com.shop.common.HmacOutboundShippingCreation;
import com.shop.common.HmacProductCreation;
import com.shop.common.HmacProductDelete;
import com.shop.common.HmacProductDetail;
import com.shop.common.HmacProductUpdate;
import com.shop.common.HmacReturnShippingCreation;
import com.shop.dto.CoupangAttributesDto;
import com.shop.dto.CoupangContentsDto;
import com.shop.dto.CoupangDetailsDto;
import com.shop.dto.CoupangDto;
import com.shop.dto.CoupangImagesDto;
import com.shop.dto.CoupangItemsDto;
import com.shop.dto.CoupangOutBoundDto;
import com.shop.dto.CoupangRequestDto;
import com.shop.dto.CoupangReturnDto;
import com.shop.entity.CoupangAttributesRepository;
import com.shop.entity.CoupangContentsRepository;
import com.shop.entity.CoupangDetailsRepository;
import com.shop.entity.CoupangImagesRepository;
import com.shop.entity.CoupangItemsRepository;
import com.shop.entity.CoupangRepository;
import com.shop.jdbc.CoupangJdbcRepository;
import com.shop.selenium.dto.SCoupangAuthentication;
import com.shop.selenium.dto.SCoupangDto;
import com.shop.selenium.dto.SCoupangLoginDto;
import com.shop.selenium.dto.SCoupangPageDto;
import com.shop.selenium.dto.SCoupangStockSearchDto;
import com.shop.selenium.util.ExtensionUtils;
import com.shop.selenium.util.ImageUtils;
import com.shop.selenium.util.JsonUtil;
import com.shop.selenium.util.ProductUtils;

import lombok.RequiredArgsConstructor;

@Transactional
@Service
@RequiredArgsConstructor
public class CoupangService {

	private final CoupangJdbcRepository coupangJdbcRepository;

	private final CoupangRepository coupangRepository;
	private final CoupangItemsRepository coupangItemsRepository;
//	private final CoupangImagesRepository coupangImagesRepository; jpa
//	private final CoupangAttributesRepository coupangAttributesRepository;
//	private final CoupangDetailsRepository coupangDetailsRepository;
//	private final CoupangContentsRepository coupangContentsRepository;

	private final HmacProductCreation hmacProductCreation;
	private final HmacOutboundShippingCreation hmacOutboundShippingCreation;
	private final HmacReturnShippingCreation hmacReturnShippingCreation;
	private final HmacProductDelete hmaProductDelete;
	private final HmacProductDetail hmacProductDetail;
	private final HmacProductUpdate hmacProductUpdate;
	
	@Value("${file.thmb-dir}")
	private String thmbDir;

	@Value("${file.detail-dir}")
	private String detailDir;

	@Transactional(readOnly = true)
	public Page<CoupangDto> getCoupangDto(Pageable pageable, int id) {

		pageable = PageRequest.of(pageable.getPageNumber() > 0 ? pageable.getPageNumber() - 1 : 0, 10);

		Page<Coupang> coupangPage = coupangRepository.findAllDesc(pageable);

		List<CoupangDto> dtoList = coupangPage.getContent().stream().map(coupang -> {
			List<CoupangItems> coupangItems = coupangItemsRepository.findItemsWithOptionalUserStatus(coupang.getId(),
					id, PageRequest.of(0, 200));
			return new CoupangDto(coupang, coupangItems);
		}).collect(Collectors.toList());

		return new PageImpl<>(dtoList, pageable, coupangPage.getTotalElements());
	}

	@Transactional(readOnly = true)
	public Page<CoupangDto> getDelCoupangDto(Pageable pageable, int id) {

		pageable = PageRequest.of(pageable.getPageNumber() > 0 ? pageable.getPageNumber() - 1 : 0, 10);

		Page<Coupang> coupangPage = coupangRepository.findAllDescDelete(pageable);

		List<CoupangDto> dtoList = coupangPage.getContent().stream().map(coupang -> {
			List<CoupangItems> coupangItems = coupangItemsRepository.findItemsWithOptionalUserStatusDelete(coupang.getId(),
					id, PageRequest.of(0, 200));
			return new CoupangDto(coupang, coupangItems);
		}).collect(Collectors.toList());

		return new PageImpl<>(dtoList, pageable, coupangPage.getTotalElements());
	}
	
	public void loginUrl(String username, String password, String url, int startPage, int endPage)
			throws InterruptedException, MalformedURLException, NoSuchElementException {
		WebDriver driver = new EdgeDriver();

		SCoupangLoginDto login = new SCoupangLoginDto(driver);
		login.click(username, password, url);
		Thread.sleep(3000);
		productPage(driver, url, startPage, endPage);
		Thread.sleep(3000);
		driver.get(url);
		driver.quit();
	}

	private void productPage(WebDriver driver, String companyUrl, int startPage, int endPage)
			throws InterruptedException, MalformedURLException {
		SCoupangPageDto page = new SCoupangPageDto(driver);
		List<String> urls = page.productNextPage(startPage, endPage);

		for (String url : urls) {
			driver.navigate().to(url);
			SCoupangDto dto = new SCoupangDto(driver);
			WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(150));

			String code = "";
			for (WebElement product : dto.getProductList()) {

				if (product.getText().contains("상품코드")) {
					String productCode = product.getText();
					productCode = productCode.replace("상품코드 ", "");
					code = productCode;
				} else if (product.getText().contains("Item #")) {
					WebElement codeElement = wait.until(ExpectedConditions.visibilityOf(product));
					String productCode = codeElement.getText();
					code = productCode.replaceAll("[^\\d]", ""); // 숫자가 아닌 모든 문자 제거
				}
			}

			WebElement titleElement = wait.until(ExpectedConditions.visibilityOf(dto.getTitle()));

			Integer existCode = coupangRepository.existsByProductCode(code, titleElement.getText());

			if (existCode == null || existCode == 0) {
				StringBuilder sbDetailFileName = new StringBuilder();
				sbDetailFileName.append("<p style='color:red; font-size: medium;' align=\"center\">"
						+ "출고 소요일 까지 약 3일 정도 소요됩니다." + "</p>");
				// price 요소를 기다리고, 로드되면 해당 WebElement를 가져옵니다.
				WebElement priceElement = wait.until(ExpectedConditions.visibilityOf(dto.getPrice()));
				// 특수문자와 모든 문자열을 자르고 amount와 더한 값
				int price = ProductUtils.productPriceConverter(priceElement.getText());

				StringBuilder sbThmbFileName = new StringBuilder();
				// 썸네일
				for (WebElement thmb : dto.getThumbLists()) {
					String imageUrl = thmb.getAttribute("src");
					String thmbUrl = ExtensionUtils.replaceWebpExtension(imageUrl, "gif");
					try {
						String uniqueThmbFileName = ImageUtils.saveThumbImage(thmbUrl, thmbDir);
						sbThmbFileName.append(uniqueThmbFileName);
					} catch (IOException e) {
						e.printStackTrace();
					}
				}
				
				JavascriptExecutor js = (JavascriptExecutor) driver;
				js.executeScript("window.scrollBy(0, 500);");
				
				List<String> detailsTexts = dto.getDetailTexts();
				String detailText = "";
				for (String detail : detailsTexts) {
					detailText = detail;
				}

				// 상세버튼 누르기
				dto.clickDetailButtonIfExists();
				// 상세이미지
				sbDetailFileName.append("<p align='center'>");
				sbDetailFileName.append("<img src='https://qudtn0295.cafe24.com/web/product/big/thmb86/"
						+ sbThmbFileName.toString() + "'/>");
				sbDetailFileName.append(detailText);
				for (WebElement detailImage : dto.getDetailImageLists()) {
					// img 태그인지 확인
					if (detailImage.getTagName().equals("img")) {

						// 이미지가 화면에 보이도록 스크롤
						ImageUtils.scrollToElement(driver, detailImage);

						// 이미지 URL 가져오기
						String imgUrl = detailImage.getAttribute("src");
						// URL에서 확장자 추출
//						String extension = imgUrl.substring(imgUrl.lastIndexOf(".") + 1).toLowerCase(); // 확장자를 소문자로 변환
						// 이미지 확장자가 유효한지 확인
//						if (extension.equals("jpg") || extension.equals("gif") || extension.equals("png")
//								|| extension.equals("jpeg")) {
							try {
								// 이미지 저장
								String uniqueDetailFileName = ImageUtils.saveDetailImage(imgUrl, detailDir);

								// HTML img 태그 추가
								sbDetailFileName.append("<img src='https://qudtn0295.cafe24.com/detailImage86/"
										+ uniqueDetailFileName + "'/>");
							} catch (MalformedURLException e) {
								// URL 오류 처리
								e.printStackTrace();
							} catch (IOException e) {
								// 파일 저장 관련 오류 처리
								e.printStackTrace();
							}
//						}
					}
				}

				dto.clickNotificationButtonIfExists();
				WebElement notificationElement = wait.until(ExpectedConditions.visibilityOf(dto.getNotification()));
				
				List<WebElement> rows = notificationElement.findElements(By.tagName("tr"));
				for (WebElement row : rows) {
					List<WebElement> cells = row.findElements(By.tagName("td"));
					for (WebElement cell : cells) {
						// 각 td에서 텍스트를 가져옵니다.
						sbDetailFileName.append("<p align='center'>");
						sbDetailFileName.append(row.getText());
						sbDetailFileName.append(cell.getText());
						sbDetailFileName.append("</p>");
					}
				}

				sbDetailFileName.append("이 상품은 코스트코에서 현재 판매 중인 상품이며 최신 상품을 정식 구매하여 발송해 드리므로 믿고 구매하셔도 됩니다. 보통 결제일 다음\n"
						+ "				 날부터 3일 이내 발송됩니다. 산간 도서 지역은 배송 기간이 추가 소요될 수 있습니다. 공급사 재고 사정에 따라 품절될 수 있으며, 가능한\n"
						+ "				 빠르게 안내 도와드리겠습니다. 배송을 위한 개인정보 제공이 발생될 수 있으므로 동의하시는 경우에만 구매 부탁드립니다. 당사는 구매대행\n"
						+ "				 중계자로 제품 정보를 일체 변경하지 않습니다 권리권 침해가 확인된 경우 연락주시면 바로 조치하겠습니다.\n"
						+ "				\n"
						+ "				 초기 불량,오배송의 경우 반품 및 환불 가능하며 판매자가 배송비를 부담합니다. 단순 변심,주문오류 등 고객의 사유로 인한 반품 및 환불은\n"
						+ "				 구매자가 배송비를 부담합니다. 임의로 타 택배사를 통해 보내시면 안됩니다");
				sbDetailFileName.append("</p>");
				
				js.executeScript("window.scrollTo(0, 0);");
				
				// 셀렉트박스 개수
				StringBuilder selectBoxEnabled = new StringBuilder();
				int size = dto.getSelectBox().size();
				String repeatedString = "F|".repeat(size);
				selectBoxEnabled.append(repeatedString);
				if (selectBoxEnabled.toString().equals("F|") || selectBoxEnabled.toString().equals("F|F|")
						|| selectBoxEnabled.toString().equals("F|F|F|")) {
					CoupangDto coupangDto = new CoupangDto();
					coupangDto.setSellerProductName(titleElement.getText());
					coupangDto.setVendorId("A00962060");
					coupangDto.setDisplayProductName(titleElement.getText());
					coupangDto.setSaleStartedAt("2024-01-19T00:00:00");
					coupangDto.setSaleEndedAt("2099-01-19T00:00:00");
					coupangDto.setDeliveryMethod("SEQUENCIAL");
					coupangDto.setDeliveryCompanyCode("EPOST");
					coupangDto.setDeliveryChargeType("NOT_FREE");
					coupangDto.setDeliveryCharge(3000);
					coupangDto.setFreeShipOverAmount(30000);
					coupangDto.setDeliveryChargeOnReturn(3000);
					coupangDto.setRemoteAreaDeliverable("N");
					coupangDto.setUnionDeliveryType("NOT_UNION_DELIVERY");
					coupangDto.setReturnCenterCode("1001694769");
					coupangDto.setReturnChargeName("경기도 안산시 상록구 충장로 565 111동1203호");
					coupangDto.setCompanyContactNumber("010-8900-6085");
					coupangDto.setReturnZipCode("15287");
					coupangDto.setReturnAddress("경기도 안산시 상록구 충장로 565");
					coupangDto.setReturnAddressDetail("111동1203호");
					coupangDto.setReturnCharge(3000);
					coupangDto.setOutboundShippingPlaceCode(19389011);
					coupangDto.setVendorUserId("qudtn0295");
					coupangDto.setRequested(true);
					coupangDto.setProductCode(code);
					coupangDto.setCurrentUrl(driver.getCurrentUrl());

					long coupangId = CoupangProductOneSave(coupangDto);

					processOptions(dto.getSelectBox(), 0, driver, "", coupangId, price, sbThmbFileName.toString(),
							sbDetailFileName.toString(), selectBoxEnabled.toString(), "", "", "",wait);

				} else if (selectBoxEnabled.toString().isEmpty() && dto.getRadioBox().size() == 0) {
					// 단일 상품
					List<CoupangAttributesDto> attributes = new ArrayList<>();
					List<CoupangItemsDto> items = new ArrayList<>();
					List<CoupangImagesDto> images = new ArrayList<>();
					List<CoupangContentsDto> contents = new ArrayList<>();
					List<CoupangDetailsDto> details = new ArrayList<>();

					CoupangDto coupang = new CoupangDto();
					coupang.setSellerProductName(titleElement.getText());
					coupang.setVendorId("A00962060");
					coupang.setDisplayProductName(titleElement.getText());
					coupang.setSaleStartedAt("2024-01-19T00:00:00");
					coupang.setSaleEndedAt("2099-01-19T00:00:00");
					coupang.setDeliveryMethod("SEQUENCIAL");
					coupang.setDeliveryCompanyCode("EPOST");
					coupang.setDeliveryChargeType("NOT_FREE");
					coupang.setDeliveryCharge(3000);
					coupang.setFreeShipOverAmount(30000);
					coupang.setDeliveryChargeOnReturn(3000);
					coupang.setRemoteAreaDeliverable("N");
					coupang.setUnionDeliveryType("NOT_UNION_DELIVERY");
					coupang.setReturnCenterCode("1001694769");
					coupang.setReturnChargeName("경기도 안산시 상록구 충장로 565 111동1203호");
					coupang.setCompanyContactNumber("010-8900-6085");
					coupang.setReturnZipCode("15287");
					coupang.setReturnAddress("경기도 안산시 상록구 충장로 565");
					coupang.setReturnAddressDetail("111동1203호");
					coupang.setReturnCharge(3000);
					coupang.setOutboundShippingPlaceCode(19389011);
					coupang.setVendorUserId("qudtn0295");
					coupang.setRequested(true);
					coupang.setProductCode(code);
					coupang.setCurrentUrl(driver.getCurrentUrl());

					String optionName = titleElement.getText();
					int productPrice = price;
					String thmbnail = sbThmbFileName.toString();
					String detailImage = sbDetailFileName.toString();
					coupangSingleProudctSave(coupang, items, attributes, images, contents, details, optionName,
							productPrice, thmbnail, detailImage);
				} else if (dto.getRadioBox().size() > 0) {
					CoupangDto coupangDto = new CoupangDto();
					coupangDto.setSellerProductName(titleElement.getText());
					coupangDto.setVendorId("A00962060");
					coupangDto.setDisplayProductName(titleElement.getText());
					coupangDto.setSaleStartedAt("2024-01-19T00:00:00");
					coupangDto.setSaleEndedAt("2099-01-19T00:00:00");
					coupangDto.setDeliveryMethod("SEQUENCIAL");
					coupangDto.setDeliveryCompanyCode("EPOST");
					coupangDto.setDeliveryChargeType("NOT_FREE");
					coupangDto.setDeliveryCharge(3000);
					coupangDto.setFreeShipOverAmount(30000);
					coupangDto.setDeliveryChargeOnReturn(3000);
					coupangDto.setRemoteAreaDeliverable("N");
					coupangDto.setUnionDeliveryType("NOT_UNION_DELIVERY");
					coupangDto.setReturnCenterCode("1001694769");
					coupangDto.setReturnChargeName("경기도 안산시 상록구 충장로 565 111동1203호");
					coupangDto.setCompanyContactNumber("010-8900-6085");
					coupangDto.setReturnZipCode("15287");
					coupangDto.setReturnAddress("경기도 안산시 상록구 충장로 565");
					coupangDto.setReturnAddressDetail("111동1203호");
					coupangDto.setReturnCharge(3000);
					coupangDto.setOutboundShippingPlaceCode(19389011);
					coupangDto.setVendorUserId("qudtn0295");
					coupangDto.setRequested(true);
					coupangDto.setProductCode(code);
					coupangDto.setCurrentUrl(driver.getCurrentUrl());

					long coupangId = CoupangProductOneSave(coupangDto);

					processRadios(driver,wait,dto.getRadioBox(),dto.getSelectBox(), coupangId, price, sbThmbFileName.toString(),
							sbDetailFileName.toString(),dto);
				}
			}
		}
	}

	@Transactional
	private void processRadios(WebDriver driver, WebDriverWait wait, List<WebElement> radios, List<WebElement> selects, long coupangId, int price, String thmb, String detailImages, SCoupangDto dto) throws InterruptedException {
		List<CoupangAttributesDto> attributes = new ArrayList<>();
		List<CoupangItemsDto> items = new ArrayList<>();
		List<CoupangImagesDto> images = new ArrayList<>();
		List<CoupangContentsDto> contents = new ArrayList<>();
		List<CoupangDetailsDto> details = new ArrayList<>();
		for (int i = 0; i < radios.size(); i++) {
	        WebElement radio = radios.get(i);

	        WebElement clickableRadio = wait.until(ExpectedConditions.elementToBeClickable(radio));
	        clickableRadio.click(); 

	        wait.until(ExpectedConditions.stalenessOf(radio)); 
	        radios = driver.findElements(By.cssSelector("body > main > div.page-content.container.main-wrapper > sip-product-details-page > sip-product-details > div > div.header-content-container.col-xs-12.col-sm-12.col-md-6.col-tab-6.ng-star-inserted > div > div > div > div > sip-variant-selector > div > div > div > ul > li > a")); // 간단한 CSS 셀렉터로 변경

	        WebElement radioText = wait.until(ExpectedConditions.presenceOfElementLocated(
	                By.cssSelector("span.product-code.ng-star-inserted")
	        ));
	        System.out.println("Product Code: " + radioText.getText());

	        CoupangItemsDto coupangItems = new CoupangItemsDto();
			coupangItems.setCoupangId(coupangId);
            coupangItems.setItemName(radioText.getText());
			coupangItems.setMaximumBuyCount(10);
			coupangItems.setMaximumBuyForPerson(0);
			coupangItems.setMaximumBuyForPersonPeriod(1);
			coupangItems.setOutboundShippingTimeDay(2);
			coupangItems.setUnitCount(0);
			coupangItems.setAdultOnly("EVERYONE");
			coupangItems.setTaxType("TAX");
			coupangItems.setParallelImported("NOT_PARALLEL_IMPORTED");
			coupangItems.setOverseasPurchased("NOT_OVERSEAS_PURCHASED");
			coupangItems.setPccNeeded(false);
			coupangItems.setOriginalPrice(price);
			coupangItems.setSalePrice(price);
			items.add(coupangItems);
			Long coupangItemsId = coupangJdbcRepository.recursiveItemsSave(coupangId, coupangItems);

			CoupangImagesDto coupangImages = new CoupangImagesDto();
			coupangImages.setCoupangId(coupangId);
			coupangImages.setImageOrder(0);
			coupangImages.setImageType("REPRESENTATION");
			coupangImages.setVendorPath("https://qudtn0295.cafe24.com/web/product/big/thmb86/" + thmb);
			coupangImages.setCoupangItemsId(coupangItemsId);
			images.add(coupangImages);

			CoupangContentsDto coupangContents = new CoupangContentsDto();
			coupangContents.setCoupangId(coupangId);
			coupangContents.setContentsType("TEXT");
			coupangContents.setCoupangItemsId(coupangItemsId);
			contents.add(coupangContents);

			Long coupangItemsContentsId = coupangJdbcRepository.recursiveItemsAndContentsSave(coupangContents);

			CoupangDetailsDto coupangDetails = new CoupangDetailsDto();
			coupangDetails.setCoupangId(coupangId);
			coupangDetails.setContent(detailImages);
			coupangDetails.setDetailType("TEXT");
			coupangDetails.setCoupangContentsId(coupangItemsContentsId);
			details.add(coupangDetails);

			CoupangAttributesDto coupangAttributes = new CoupangAttributesDto();
			if (radios.size() > 0) {
				coupangAttributes.setCoupangId(coupangId);
				coupangAttributes.setAttributeTypeName("옵션");
				coupangAttributes.setAttributeValueName(radioText.getText());
				coupangAttributes.setCoupangItem(coupangItemsId);

			}
			attributes.add(coupangAttributes);

	    }
		coupangJdbcRepository.itemsImagesSave(images);
		coupangJdbcRepository.itemsAttriutesSave(attributes);
		coupangJdbcRepository.itemsDetailsSave(details);
	}

	private void processOptions(List<WebElement> allSelects, int index, WebDriver driver, String combinedOption,
			Long coupangId, int price, String thmb, String detailImages, String selectBox, String firstOption,
			String secondOption, String thirdOption, WebDriverWait wait) throws InterruptedException {

		List<CoupangAttributesDto> attributes = new ArrayList<>();
		List<CoupangItemsDto> items = new ArrayList<>();
		List<CoupangImagesDto> images = new ArrayList<>();
		List<CoupangContentsDto> contents = new ArrayList<>();
		List<CoupangDetailsDto> details = new ArrayList<>();
		// 모든 옵션을 처리했을 때 종료
		if (index >= allSelects.size()) {
			if (!combinedOption.contains("품절") && !combinedOption.contains("단종")) {
				if (selectBox.equals("F|") || selectBox.equals("F|F|") || selectBox.equals("F|F|F|")) {
					CoupangItemsDto coupangItems = new CoupangItemsDto();
					coupangItems.setCoupangId(coupangId);
					coupangItems.setItemName(combinedOption);
					coupangItems.setMaximumBuyCount(10);
					coupangItems.setMaximumBuyForPerson(0);
					coupangItems.setMaximumBuyForPersonPeriod(1);
					coupangItems.setOutboundShippingTimeDay(2);
					coupangItems.setUnitCount(0);
					coupangItems.setAdultOnly("EVERYONE");
					coupangItems.setTaxType("TAX");
					coupangItems.setParallelImported("NOT_PARALLEL_IMPORTED");
					coupangItems.setOverseasPurchased("NOT_OVERSEAS_PURCHASED");
					coupangItems.setPccNeeded(false);
					coupangItems.setOriginalPrice(price);
					coupangItems.setSalePrice(price);
					items.add(coupangItems);
					Long coupangItemsId = coupangJdbcRepository.recursiveItemsSave(coupangId, coupangItems);

					CoupangImagesDto coupangImages = new CoupangImagesDto();
					coupangImages.setCoupangId(coupangId);
					coupangImages.setImageOrder(0);
					coupangImages.setImageType("REPRESENTATION");
					coupangImages.setVendorPath("https://qudtn0295.cafe24.com/web/product/big/thmb86/" + thmb);
					coupangImages.setCoupangItemsId(coupangItemsId);
					images.add(coupangImages);

					CoupangContentsDto coupangContents = new CoupangContentsDto();
					coupangContents.setCoupangId(coupangId);
					coupangContents.setContentsType("TEXT");
					coupangContents.setCoupangItemsId(coupangItemsId);
					contents.add(coupangContents);

					Long coupangItemsContentsId = coupangJdbcRepository.recursiveItemsAndContentsSave(coupangContents);
					CoupangDetailsDto coupangDetails = new CoupangDetailsDto();
					coupangDetails.setCoupangId(coupangId);
					coupangDetails.setContent(detailImages);
					coupangDetails.setDetailType("TEXT");
					coupangDetails.setCoupangContentsId(coupangItemsContentsId);
					details.add(coupangDetails);

					// 속성 추가
					if (selectBox.equals("F|")) {
						CoupangAttributesDto coupangAttributes = new CoupangAttributesDto();
						coupangAttributes.setCoupangId(coupangId);
						coupangAttributes.setAttributeTypeName("옵션");
						coupangAttributes.setAttributeValueName(firstOption);
						coupangAttributes.setCoupangItem(coupangItemsId);

						attributes.add(coupangAttributes);
					} else if (selectBox.equals("F|F|") && !combinedOption.isEmpty()) {
						CoupangAttributesDto coupangAttributes = new CoupangAttributesDto();
						coupangAttributes.setCoupangId(coupangId);
						coupangAttributes.setAttributeTypeName("옵션");
						coupangAttributes.setAttributeValueName(secondOption);
						coupangAttributes.setCoupangItem(coupangItemsId);

						CoupangAttributesDto coupangAttributes2 = new CoupangAttributesDto();
						coupangAttributes2.setCoupangId(coupangId);
						coupangAttributes2.setAttributeTypeName("옵션2");
						coupangAttributes2.setAttributeValueName(firstOption);
						coupangAttributes2.setCoupangItem(coupangItemsId);

						attributes.add(coupangAttributes);
						attributes.add(coupangAttributes2);
					} else if (selectBox.equals("F|F|F|") && !combinedOption.isEmpty()) {
						CoupangAttributesDto coupangAttributes = new CoupangAttributesDto();
						coupangAttributes.setAttributeTypeName("옵션");
						coupangAttributes.setAttributeValueName(secondOption);
						coupangAttributes.setCoupangId(coupangId);
						coupangAttributes.setCoupangItem(coupangItemsId);

						CoupangAttributesDto coupangAttributes2 = new CoupangAttributesDto();
						coupangAttributes2.setAttributeTypeName("옵션2");
						coupangAttributes2.setAttributeValueName(firstOption);
						coupangAttributes2.setCoupangId(coupangId);
						coupangAttributes.setCoupangItem(coupangItemsId);

						CoupangAttributesDto coupangAttributes3 = new CoupangAttributesDto();
						coupangAttributes3.setAttributeTypeName("옵션3");
						coupangAttributes3.setAttributeValueName(thirdOption);
						coupangAttributes3.setCoupangId(coupangId);
						coupangAttributes.setCoupangItem(coupangItemsId);

						attributes.add(coupangAttributes);
						attributes.add(coupangAttributes2);
						attributes.add(coupangAttributes3);
					}
				}
			}

			CoupangProductSave(coupangId, items, images, attributes, details, contents);
			return;
		}

		Select select = new Select(allSelects.get(index));
		try {
			select.selectByIndex(2);
		}catch(NoSuchElementException e){
			select.selectByIndex(1);
			System.out.println(e.getMessage());
		}
		List<WebElement> options = select.getOptions();
//		options.remove(0);
		
		for (WebElement option : options) {
			String optionValue = option.getText().trim();
			if (!optionValue.isEmpty() && !optionValue.equals("-------------------") && !optionValue.equals("선택 사이즈")) {
				String newCombinedOption = combinedOption.isEmpty() ? optionValue : combinedOption + " " + optionValue;
				if (index == 0) {
					processOptions(allSelects, index + 1, driver, newCombinedOption, coupangId, price, thmb,
							detailImages, selectBox, optionValue, secondOption, thirdOption,wait);
				} else if (index == 1) {
					processOptions(allSelects, index + 1, driver, newCombinedOption, coupangId, price, thmb,
							detailImages, selectBox, firstOption, optionValue, thirdOption,wait);
				} else if (index == 2) {
					processOptions(allSelects, index + 1, driver, newCombinedOption, coupangId, price, thmb,
							detailImages, selectBox, firstOption, secondOption, optionValue,wait);
				}
			}
		}
		
	}

	// 싱글 옵션 없음
	@Transactional
	private void coupangSingleProudctSave(CoupangDto coupang, List<CoupangItemsDto> items,
			List<CoupangAttributesDto> attributes, List<CoupangImagesDto> images, List<CoupangContentsDto> contents,
			List<CoupangDetailsDto> details, String optionName, int productPrice, String thmbnail, String detailImage) {

		long coupangId = coupangJdbcRepository.save(coupang);

		CoupangItemsDto coupangItems = new CoupangItemsDto();
		coupangItems.setItemName(optionName);
		coupangItems.setMaximumBuyCount(10);
		coupangItems.setMaximumBuyForPerson(0);
		coupangItems.setMaximumBuyForPersonPeriod(1);
		coupangItems.setOutboundShippingTimeDay(2);
		coupangItems.setUnitCount(0);
		coupangItems.setAdultOnly("EVERYONE");
		coupangItems.setTaxType("TAX");
		coupangItems.setParallelImported("NOT_PARALLEL_IMPORTED");
		coupangItems.setOverseasPurchased("NOT_OVERSEAS_PURCHASED");
		coupangItems.setPccNeeded(false);
		coupangItems.setOriginalPrice(productPrice);
		coupangItems.setSalePrice(productPrice);
		coupangItems.setCoupangId(coupangId);
		items.add(coupangItems);
		List<Long> coupangItemsId = coupangJdbcRepository.itemsSave(coupangId, items);

		for (Long itemId : coupangItemsId) {
			CoupangImagesDto coupangImages = new CoupangImagesDto();
			coupangImages.setImageOrder(0);
			coupangImages.setImageType("REPRESENTATION");
			coupangImages.setVendorPath("https://qudtn0295.cafe24.com/web/product/big/thmb86/" + thmbnail);
			coupangImages.setCoupangItemsId(itemId);
			coupangImages.setCoupangId(coupangId);
			images.add(coupangImages);

			CoupangContentsDto coupangContents = new CoupangContentsDto();
			coupangContents.setContentsType("TEXT");
			coupangContents.setCoupangId(coupangId);
			coupangContents.setCoupangItemsId(itemId);
			contents.add(coupangContents);

		}

		List<Long> coupangContensId = coupangJdbcRepository.itemsImagesAndContentsSave(images, contents, coupangId);
		for (Long contentsId : coupangContensId) {
			CoupangDetailsDto coupangDetails = new CoupangDetailsDto();
			coupangDetails.setContent(detailImage);
			coupangDetails.setDetailType("TEXT");
			coupangDetails.setCoupangContentsId(contentsId);
			coupangDetails.setCoupangId(coupangId);
			details.add(coupangDetails);
		}
		coupangJdbcRepository.itemsDetailsSave(details);

	}

	@Transactional
	private Long CoupangProductOneSave(CoupangDto coupangDto) {
		long coupangId = coupangJdbcRepository.save(coupangDto);
		return coupangId;
	}

	@Transactional
	private void CoupangProductSave(Long coupangId, List<CoupangItemsDto> items, List<CoupangImagesDto> images,
			List<CoupangAttributesDto> attributes, List<CoupangDetailsDto> details, List<CoupangContentsDto> contents) {

		coupangJdbcRepository.itemsImagesSave(images);
		coupangJdbcRepository.itemsAttriutesSave(attributes);
		coupangJdbcRepository.itemsDetailsSave(details);
	}

	@Transactional
	public List<CoupangDto> selectedListCoupang(CoupangRequestDto selectedCoupangProducts) throws URISyntaxException {

		List<CoupangDto> dtoList = new ArrayList<>();
		Pageable itemLimit = PageRequest.of(0, 200);

		List<String> tagsList = Arrays.asList(selectedCoupangProducts.getSearchTags().split(","));

		List<Long> coupangItemsId = new ArrayList<>();
		for (Long selected : selectedCoupangProducts.getSelectedCoupangProducts()) {
			Coupang coupang = coupangRepository.findById(selected)
					.orElseThrow(() -> new IllegalArgumentException("쿠팡 번호가 없음=" + selected));
			URI uri = new URI(coupang.getCurrentUrl());
			String host = uri.getHost();
			String brand = "";
			if (host.equals("trycozy.com")) {
				brand = ProductUtils.replaceBracketsWithConverter(coupang.getDisplayProductName(),
						selectedCoupangProducts.getBrand());
			} else if (host.equals("carssenb2b.com")) {
				brand = ProductUtils.replaceBracketsCarssenWithConverter(coupang.getDisplayProductName(),
						selectedCoupangProducts.getBrand());
			} else {
				brand = ProductUtils.replaceBracketsWithConverter(coupang.getDisplayProductName(),
						selectedCoupangProducts.getBrand());
			}

			List<CoupangItems> coupangItems = Collections.emptyList();
			if (coupang.getItems() != null && !coupang.getItems().isEmpty()) {
				coupangItems = coupangItemsRepository.findItemsWithOptionalUserStatus(coupang.getId(),
						selectedCoupangProducts.getId(), itemLimit);
				for (CoupangItems item : coupangItems) {
					coupangItemsId.add(item.getItemId());
				}
			}
			dtoList.add(new CoupangDto(coupang, coupangItems, brand, selectedCoupangProducts.getPrice(), tagsList));
		}

		for (CoupangDto dto : dtoList) {
			if (dto.getItems() != null && !dto.getItems().isEmpty()) {
				String json = JsonUtil.convertListToJson(dto);
				hmacProductCreation.sendDataToCoupang(json, dto.getId(), coupangItemsId,
						selectedCoupangProducts.getId());
				try {
					TimeUnit.SECONDS.sleep(3);
				} catch (InterruptedException e) {
					Thread.currentThread().interrupt();
				}
			}
		}

		return dtoList;
	}

	public void outboundShipping(CoupangOutBoundDto coupangOutBoundRequest) {
		String json = JsonUtil.convertListToJson(coupangOutBoundRequest);
		hmacOutboundShippingCreation.sendDataToCoupang(json);
	}

	public void returnShipping(CoupangReturnDto coupangReturnDto) {
		String json = JsonUtil.convertListToJson(coupangReturnDto);
		hmacReturnShippingCreation.sendDataToCoupang(json);
	}

	@Transactional(readOnly = true)
	public CoupangDto getCoupangDetail(Long coupangId, int userId) {
		Coupang coupang = coupangRepository.findById(coupangId)
				.orElseThrow(() -> new IllegalArgumentException("coupangId not found"));

		List<CoupangItems> coupangItems = coupangItemsRepository.findItemsWithOptionalUserStatus(coupang.getId(),
				userId, PageRequest.of(0, 200));

		return new CoupangDto(coupang, coupangItems);
	}

	@Transactional
	public void deleteCoupang(long id, long productSellerId) throws InterruptedException {
	    List<Long> productItemsId = hmacProductDetail.detailDataToCoupang(productSellerId);
		for(Long itemId:productItemsId) {
			hmacProductUpdate.updateDataToCoupang(itemId);
		}
		hmaProductDelete.deleteDataToCoupang(productSellerId);
	    coupangRepository.deleteById(id);
	}
	
	@Transactional
	public void stockCoupangDelete(String email) throws InterruptedException {

		WebDriver driver = new EdgeDriver();
		driver.get("https://www.costco.co.kr/");
		
		SCoupangLoginDto login = new SCoupangLoginDto(driver);
		SCoupangStockSearchDto stockSearchDto = new SCoupangStockSearchDto(driver);
		
		login.deleteClick(email, "qudtn!4589");
	    List<Coupang> coupangs = coupangRepository.findAll();
	    List<String> stockSoldOut = stockSearchDto.search(coupangs);

	    for (Coupang coupang : coupangs) {
	        if (stockSoldOut.contains(coupang.getProductCode())) {
	            List<Long> productItemsId = hmacProductDetail.detailDataToCoupang(coupang.getSellerProductId());
	            for (Long itemId : productItemsId) {
	                hmacProductUpdate.updateDataToCoupang(itemId);
	            }
	            hmaProductDelete.deleteDataToCoupang(coupang.getSellerProductId());
	            coupangRepository.deleteById(coupang.getId());
	        }
	    }
	    
	}

	@Transactional
	public void deleteOneCoupang(Long id) {
		coupangRepository.deleteById(id);
	}

}
