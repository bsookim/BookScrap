package com.scrap.pom;

import java.util.ArrayList;
import java.util.List;

import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.FindBy;
import org.openqa.selenium.support.PageFactory;

import com.scrap.data.BooksData;
import com.scrap.entity.BookCategory;
import com.scrap.entity.Books;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;

@NoArgsConstructor
@AllArgsConstructor
@Getter
public class SeleniumBooks {

    // 초기화
    public void init(WebDriver driver) {
        PageFactory.initElements(driver, this);
    }

    @FindBy(css="#content_inner > article > div.row > div.col-sm-6.product_main > h1")
    private WebElement title;

    @FindBy(css="#content_inner > article > div.row > div.col-sm-6.product_main > p.price_color")
    private WebElement price;

    @FindBy(css="#content_inner > article > div.row > div.col-sm-6.product_main > p.instock.availability")
    private WebElement stock;

    @FindBy(css="#content_inner > article > p")
    private WebElement descpription;

    @FindBy(xpath = "//table[@class='table table-striped']//th[text()='UPC']/following-sibling::td")
    private WebElement upc;

    @FindBy(xpath = "//table[@class='table table-striped']//th[text()='Product Type']/following-sibling::td")
    private WebElement productType;

    @FindBy(css="#product_gallery > div > div > div > img")
    private WebElement thumbNail;

    // ✅ ul.breadcrumb > li 전체를 가져옴
    @FindBy(css="ul.breadcrumb > li")
    private List<WebElement> categoryList;

    // 카테고리별 책 URL 가져오기
    public BooksData booksHref(WebDriver driver, SeleniumBookCategory sbc) {
        BooksData bookData = new BooksData();
        List<String> categoryUrls = new ArrayList<>();

        for (WebElement category : sbc.getCategoryUrls()) {
            String href = category.getDomProperty("href");
            categoryUrls.add(href);

            BookCategory bookCategory = BookCategory.builder()
                    .categoryUrl(href)
                    .categoryText(category.getText())
                    .build();
            bookData.getBookCategoryList().add(bookCategory);
        }

        List<String> allBookUrls = new ArrayList<>();
        for (String categoryUrl : categoryUrls) {
            driver.get(categoryUrl);

            Integer end = null;
            try {
                WebElement endPageElement = driver.findElement(
                        By.cssSelector("#default > div > div > div > div > section > div:nth-child(2) > div > ul > li.current")
                );
                end = Integer.parseInt(endPageElement.getText().replaceAll("Page 1 of ", ""));
            } catch (NoSuchElementException e) {}

            if (end == null) {
                List<WebElement> hrefsOnPage = driver.findElements(By.cssSelector("div.image_container a"));
                allBookUrls.addAll(detailUrls(hrefsOnPage));
            } else {
                for (int i = 1; i <= end; i++) {
                    List<WebElement> hrefsOnPage = driver.findElements(By.cssSelector("div.image_container a"));
                    allBookUrls.addAll(detailUrls(hrefsOnPage));

                    List<WebElement> nextButtons = driver.findElements(By.cssSelector("li.next > a"));
                    if (!nextButtons.isEmpty()) {
                        clickNoSuchException(nextButtons.get(0));
                    }
                }
            }
        }

        bookData.getUrls().addAll(allBookUrls);
        return bookData;
    }

    // 상세 페이지에서 책 정보 수집
    public List<Books> booksDetailPage(WebDriver driver, List<String> urls) {
        List<Books> books = new ArrayList<>();

        for (String url : urls) {
            driver.get(url);

            SeleniumBooks sb = new SeleniumBooks();
            PageFactory.initElements(driver, sb);

            // ✅ breadcrumb 전체 li를 리스트로 저장
            List<String> categoryTexts = new ArrayList<>();
            for (WebElement li : sb.categoryList) {
                try {
                    categoryTexts.add(li.getText().trim());
                } catch (NoSuchElementException e) {}
            }
            System.out.println(categoryTexts);
            Books book = Books.builder()
                    .title(textNoSuchException(sb.title))
                    .price(textNoSuchException(sb.price))
                    .stock(textNoSuchException(sb.stock))
                    .descpription(textNoSuchException(sb.descpription))
                    .upc(textNoSuchException(sb.upc))
                    .productType(textNoSuchException(sb.productType))
                    .currnetUrl(driver.getCurrentUrl())
                    .thumbNail(sb.thumbNail.getDomProperty("src"))
                    .category(categoryTexts) // ✅ 전체 breadcrumb 리스트 저장
                    .build();

            books.add(book);
        }

        return books;
    }

    public List<String> detailUrls(List<WebElement> list) {
        List<String> urls = new ArrayList<>();
        for (WebElement a : list) {
            urls.add(a.getDomProperty("href"));
        }
        return urls;
    }

    public String textNoSuchException(WebElement element) {
        try {
            return element.getText();
        } catch (NoSuchElementException e) {
            return "";
        }
    }

    public void clickNoSuchException(WebElement element) {
        try {
            element.click();
        } catch (NoSuchElementException e) {}
    }
}