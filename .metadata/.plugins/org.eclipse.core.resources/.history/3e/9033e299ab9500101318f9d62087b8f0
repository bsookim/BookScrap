package com.coupang.scrap.list;

import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;

import org.openqa.selenium.*;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import com.coupang.factory.CoupangRequestList;
import com.coupang.scrap.view.ProductViewHandler;
import com.coupang.repository.CoupangRepository;

public class EchobelleProductListPage implements ProductListPage {

    private final List<WebDriver> driverPool;
    private final BlockingQueue<WebDriver> availableDrivers = new LinkedBlockingQueue<>();
    private final String baseUrl;
    private final int endPage;
    private static final String MORE_BUTTON_SELECTOR = "input[id='more'][type='button'][value*='Îçî Î≥¥Í∏∞']";

    public EchobelleProductListPage(WebDriver driver, String url, int endPage) {
        this.driverPool = List.of(driver);
        this.baseUrl = url;
        this.endPage = endPage;
        initDriverPool();
    }

    private void initDriverPool() {
        availableDrivers.addAll(driverPool);
    }

    private WebDriver acquireDriver() throws InterruptedException {
        return availableDrivers.take();
    }

    private void releaseDriver(WebDriver driver) {
        availableDrivers.offer(driver);
    }

    private List<WebElement> loadAllProductRowsWithDriver(WebDriver driver) {
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));

        while (true) {
            try {
                WebElement moreButton = driver.findElement(By.cssSelector(MORE_BUTTON_SELECTOR));
                if (moreButton.isDisplayed() && moreButton.isEnabled()) {
                    int currentCount = driver.findElements(By.cssSelector("tr.list-body")).size();
                    moreButton.click();
                    // ÏÉà row Î°úÎî© ÎåÄÍ∏∞
                    wait.until(d -> driver.findElements(By.cssSelector("tr.list-body")).size() > currentCount);
                } else {
                    break;
                }
            } catch (StaleElementReferenceException | NoSuchElementException | TimeoutException ignored) {
                break;
            }
        }

        // Î™®Îì† row Ìïú Î≤àÏóê Î∞òÌôò
        return new ArrayList<>(driver.findElements(By.cssSelector("tr.list-body")));
    }

    @Override
    public List<WebElement> getProductLinks() {
        try {
            WebDriver driver = driverPool.get(0);
            return loadAllProductRowsWithDriver(driver);
        } catch (Exception e) {
            e.printStackTrace();
            return List.of();
        }
    }

    @Override
    public CoupangRequestList collectProducts(WebDriver unusedDriver, int startPage, int endPage,
                                              ProductViewHandler handler, CoupangRepository repository) {
        CoupangRequestList allRequestList = new CoupangRequestList();

        try {
            WebDriver driver = acquireDriver();

            try {
                List<WebElement> rows = loadAllProductRowsWithDriver(driver);
                System.out.println("Ï¥ù row Í∞úÏàò: " + rows.size());

                // üîπ ÏïàÏ†ÑÌïòÍ≤å ÏàúÏ∞® Ï≤òÎ¶¨
                for (WebElement row : rows) {
                    try {
                        CoupangRequestList rowResult = handler.handleFromElement(driver, row, repository);
                        if (rowResult != null) allRequestList.merge(rowResult);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            } finally {
                releaseDriver(driver);
            }
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }

        return allRequestList;
    }
}
