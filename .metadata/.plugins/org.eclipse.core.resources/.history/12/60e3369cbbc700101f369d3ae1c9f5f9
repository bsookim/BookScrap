package com.scrap.service;

import org.springframework.data.domain.Pageable;
import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.select.Elements;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.By;
import org.openqa.selenium.By.ByCssSelector;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.Wait;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.scrap.data.BooksData;
import com.scrap.entity.BookCategory;
import com.scrap.entity.Books;
import com.scrap.pom.SeleniumBookCategory;
import com.scrap.pom.SeleniumBooks;
import com.scrap.repository.BookCategoryRepository;
import com.scrap.repository.BooksRepository;
import com.scrap.response.BooksDetailResponse;
import com.scrap.response.BooksListResponse;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class BooksService {

	private final BooksRepository booksRepository; 
	
	private final BookCategoryRepository bookCategoryRepository;
	
	public void booksSave(String currentUrl) {
	    WebDriver driver = new ChromeDriver();

	    try {
	        driver.get(currentUrl);
	        Wait<WebDriver> wait = new WebDriverWait(driver, Duration.ofSeconds(2));
	        WebElement body = driver.findElement(By.cssSelector("body"));
	        wait.until(ExpectedConditions.visibilityOf(body));

	        SeleniumBookCategory sbc = new SeleniumBookCategory(driver);
	        SeleniumBooks sb = new SeleniumBooks();

	        BooksData bookData = sb.booksHref(driver, sbc);
	        List<Books> books = sb.booksDetailPage(driver, bookData.getUrls());

	        bookData.getBookList().addAll(books);
	        bookSaveAll(bookData.getBookCategoryList(),bookData.getBookList());
	        
	    } finally {
	        driver.quit();
	    }
	}
	
	@Transactional
	public void bookSaveAll(List<BookCategory> bookCategory, List<Books> books) {
		bookCategoryRepository.saveAll(bookCategory);
        booksRepository.saveAll(books);
	}

	@Transactional(readOnly = true)
	public Page<BooksListResponse> bookList(String category, Pageable pageable) {
	    // DB에서 페이징 조회
	    Page<Books> booksPage = booksRepository.findByCategory(category, pageable);

	    // Books -> DTO 변환
	    List<BooksListResponse> booksResponseList = booksPage.getContent().stream()
	            .map(BooksListResponse::booksResponse)
	            .toList(); // Java 16 이상은 toList() 가능, 이전 버전은 collect(Collectors.toList())

	    // 실제 DB에서 가져온 totalElements 사용
	    return new PageImpl<>(
	            booksResponseList,
	            pageable,
	            booksPage.getTotalElements() // 이 부분이 중요, totalElements를 정확하게 가져와야 함
	    );
	}


	@Transactional(readOnly = true)
	public BooksDetailResponse bookDetail(Long id) {
		Books book= booksRepository.findById(id).orElseThrow();
		BooksDetailResponse booksResponse=	BooksDetailResponse.booksDetailResponse(book);
		return booksResponse;
	}

	@Transactional
	public void bookDelete(Long id) {
		booksRepository.deleteById(id);
	}

	public String bookUpdate() {
		Books book=booksRepository.findById(null).orElseThrow();
		book.setTitle(null);
		
		booksRepository.save(null);
		return "타이틀이 수정되었습니다.";
	}
}
